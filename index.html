<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
  <title>BitBay Swap</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="stylesheet" type="text/css" href="./assets/css/chartist.min.css">
  <link rel="stylesheet" href="./assets/css/nouislider.min.css">
  <!-- <link rel="stylesheet" href="./assets/css/line.css"> -->
  <link rel="stylesheet" href="./assets/css/style.css">
</head>

<body>

  <div class="wrap" id="wrap">
  <!-- top menu -->
   
   <!--
  <div class="main">
      <div class="align1">
        <a href="https://www.w3docs.com/learn-html.html"><a href="index.html"><img src="icon.png" class="header_logo"></a></a>
      </div>
      <div class="align2">
        <div class="select-menu" id="swap_network">
          <div class="select-btn">
              <span class="sBtn-text"><button><i class="icon uil uil-globe"></i> Network <i class="icon arrow uil uil-arrow-down"></i></button></span>
              <i class="bx bx-chevron-down"></i>
          </div>
 
          <ul class="options">
              <li class="option">
                  <i class="bx bxl-github" style="color: #171515;"></i>
                  <span class="option-text">Ethereum (Sepolia Testnet)</span>
              </li>
              
          </ul>
      </div>
      </div>
      <div class="align3">
        <div class="sec-center">  
              
              <input class="dropdown" type="checkbox" id="dropdown" name="dropdown"/>
              <label class="for-dropdown" for="dropdown">Menu <i class="uil uil-arrow-down"></i></label>
            <div class="section-dropdown"> 
              <a href="./information.html">FAQ about the Bridge <i class="uil uil-arrow-right"></i></a>
              <a href="https://www.bitbay.market" target="_blank">Learn more about BitBay <i class="uil uil-arrow-right"></i></a>
              <a href="https://github.com/dzimbeck/BitBay-Solidity" target="_blank">Open source code on Github <i class="uil uil-arrow-right"></i></a>

              <input class="dropdown-sub" type="checkbox" id="dropdown-sub" name="dropdown-sub"/>
              <label class="for-dropdown-sub" for="dropdown-sub">Help <i class="uil uil-plus"></i></label>
              <div class="section-dropdown-sub"> 
                <a href="#">Documentation <i class="uil uil-arrow-right"></i></a>
                <a href="#">Dropdown Link <i class="uil uil-arrow-right"></i></a>
              </div>
            </div>
        </div>
      </div>
    </div>
  -->


  <div class="top_menu " >
    
      <div class="top_menu_content_left">
        <a href="index.html"><img src="icon.png" class="header_logo"></a>
      </div>
      <div class="top_menu_content_center">
        
        <!-- <button><i class="icon uil uil-link"></i> Connect&nbsp;Wallet</button>

         <button><i class="icon uil uil-wallet"></i> Balance</button> -->

        <div class="select-menu" id="swap_network">
          <div class="select-btn">
              <span class="sBtn-text">
                <span class="btn swapSelector"><img class="icon network" src="./assets/images/network.svg"> Network <img class="icon uil uil-arrow-down" src="./assets/images/arrow-down.svg"></span></span>
              <i class="bx bx-chevron-down"></i>
          </div>
 
          <ul class="options">
              <li class="option">
                  <i class="bx bxl-github" style="color: #171515;"></i>
                  <span class="option-text" id="current-network">Polygon</span>
              </li>
              
          </ul>
      </div>

      </div>
      <div class="top_menu_content_right">
        
        <div class="sec-center">  
              <!-- <button>?</button> !-->
              <input class="dropdown" type="checkbox" id="dropdown" name="dropdown"/>
              <label class="for-dropdown" for="dropdown">Menu <img class="icon uil uil-arrow-down" src="./assets/images/arrow-down.svg"></label>
            <div class="section-dropdown"> 
              <a href="./information.html">FAQ about the Bridge</a>
              <a href="https://www.bitbay.market" target="_blank">Learn more about BitBay</a>
              <a href="https://github.com/dzimbeck/BitBay-Solidity" target="_blank">Open source code on Github</a>


              <input class="dropdown-sub" type="checkbox" id="dropdown-sub" name="dropdown-sub"/>
              <label class="for-dropdown-sub" for="dropdown-sub">Help ‚Üí</label>
              <div class="section-dropdown-sub"> 
                <a href="https://t.me/bitbayofficial" target="_blank">BitBay Telegram</a>
                <a href="https://nighttrader.exchange/" target="_blank">NightTrader Exchange</a>
              </div>
            </div>
        </div>

      </div>
  </div>

  <!--PEN HEADER-->
  <div class="header">
    <img src="assets/images/bitbay-logo-medium.png" class="main_logo">
  </div>
  <!--PEN CONTENT-->
  <div class="content">
    <!--content title-->
    <h2 class="content__title">
      <!-- <button onclick="login()" class="not-logged-in login_btn"><i class="uil uil-link"></i> Connect Wallet</button> -->
      
      <div class=" swapSelector btn not-logged-in login_btn" onclick="login()">
            <img class="swapSelectorLogo uil uil-link" src="./assets/images/link.svg">
            <div class="swapSelectorText">Connect Wallet</div>
      </div>

    </h2>
 
    <div class="box">
      <div class="callout callout-success logged-in hidden" id="balance_network">
      </div>
    </div>

      <!--tabs-menu !-->

      <div class="tabs_menu">
        <!--tabs navigation-->
        <div class="tabs__nav">
          <ul class="tabs__nav-list">
            <li class="tabs__nav-item js-active">Info</li>
            <li class="tabs__nav-item">Swap</li>
            <li class="tabs__nav-item">Liquidity</li>
            <li class="tabs__nav-item">Bridge</li>
          </ul>
        </div>
      </div>

    <!--content inner-->
    <div class="content__inner">

      <!-- tabs-content !-->
      <div class="tabs">

        <!-- trade settings button -->

                <div class="settingField hidden" id="slippageField">
                  <div class="boxTitle">
                    <small>Min/Max price fluctuation for swaps or deposits.</small>
                  </div>
                  <div class="input-group">
                      <div  class="btn-inside btn-inside-start">Slippage</div>
                      <input type="number"  id="CoinPercent" class="form_field buttons-inside" placeholder="10.00" value="10" required="">
                      <div  class="btn-inside btn-inside-end">%</div>
                  </div>
                </div>
                <div class="settingField">
                  
                </div>

        <!--tabs panels-->
        <div class="tabs__panels">
          <!--info panel-->
          <div class="tabs__panel info_panel">   

            <div class="callout callout-no-border logged-in hidden">
              Contract info:<hr>
              <div id="contractinfo">
              </div>
            </div>

<hr class="logged-in hidden">
    <div class="swapBody">
      <div class="swapFields">
        <div class="boxTitle ">
          ‚ùÑÔ∏è Frozen Coins
        </div>

        <div class="swapField">
          <div class=" swapSelector btn" onclick="showFrozen()">
            <img class="swapSelectorLogo" src="./icon.png">
            <div class="swapSelectorText"> Frozen Coins Details</div>
            
          </div>

          <div class=" swapSelector btn" onclick="sendFrozen()">
            <img class="swapSelectorLogo" src="./icon.png">
            <div class="swapSelectorText">Release Frozen Funds</div>
            
          </div>
        </div>
    
        <br>
        <div class="boxTitle ">
          üìä Show Liquid/Reserve Chart
        </div>
        <div class="swapField info_chart">
          
          <span class="btn swapSelector" onclick="showPegChart()" id="showPegChart">Show Liquid/Reserve Chart üìä</span><br>
            <div class="chart_inputs  hidden" id="chartContainerInputs">
              <div class="chart-slider-container">
                <div class="style-2 wrapper m-b-50 p-l-r">
                  <div class="slider-keypress m-b-20"></div>
                  <input type="text" class="input-with-keypress-0" id="range1" required>
                  <input type="text" class="input-with-keypress-1" id="range2" required>
                </div>
              </div>
            </div>
            <div id="chartContainer" class="  hidden" style="height: 150px; border: 5px solid #d9dbda; border-radius: 10px"></div>

        </div>
      </div>
    </div>
            <br><hr class="logged-in hidden">
            <br>
            <div class="callout callout-success logged-in hidden">
              Network info:<hr>
              <div id="networkinfo">
              </div>
            </div>

          </div>
          <!--swap panel-->
          <div class="tabs__panel">
            
            <p id="exchangeImage"></p>
            <p id="swapintro">
            <div class="callout">
              Decentralized exchange through Uniswap, Pancakeswap and more</p>
              Please note: All deposits and withdraws must take place using the official BitBay router contract.
              <br><a href="./information.html">See the FAQ to learn why.</a><br>
            </div>

            <br>
            
            <!-- /*swap interface - start*/ -->
            
            <select id="exchangeSelect" class="logged-in hidden">
            </select>

<div class="swapBody">
  <div class="swapFields">
        <div class="boxTitle swapFirstCoinTxt">
          Buy BitBay
        </div>

        <div class="swapField">
          <div class="swapFirstCoin swapSelector btn">
            <img class="swapSelectorLogo" src="./icon.png">
            <div class="swapSelectorText" id="swapCoin1Text">BAY</div>
            <div class="swapSelectorArrow">
              <svg width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg" class="sc-33m4yg-8 khlnVY"><path d="M0.97168 1L6.20532 6L11.439 1" stroke="#AEAEAE"></path></svg>
            </div>
          </div>
          <input class="swapTextInput" type="text" placeholder="0.0" id="SwapAmount">
        </div>

        <div class="swapArrow">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6E727D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
        </div>

        <div class="boxTitle swapSecondCoinTxt">
          in exchange for
        </div>
        <div class="swapField">
          <div class="swapSecondCoin swapSelector btn">
            <img class="swapSelectorLogo" src="./assets/images/0xmnr.png">
            <div class="swapSelectorText" id="swapCoin2Text">Wrapped ETH</div>
            <div class="swapSelectorArrow">
              <svg width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg" class="sc-33m4yg-8 khlnVY"><path d="M0.97168 1L6.20532 6L11.439 1" stroke="#AEAEAE"></path></svg>
            </div>
          </div>
          <input class="swapTextInput" type="text" placeholder="0.0" id="SwapAmount2">
        </div>
      </div>
      
      <div class="callout swapInfoSummary logged-in hidden">
        <div class="swapInfo">
          
          <div class="swapInfoLine">
            <span class="left">Order Summary</span>
            <div class="right">
              <span></span>
              <span class="important-text"></span>
            </div>
          </div>

          <div id="SwapSummary">
          
        </div>

        </div>

      </div>

      <a href="#" class="swapButton logged-in hidden" onclick="Swap()">Swap </a>

</div>
            <!--
/*swap interface - end*/
            -->

            <select id="SwapCoin" >
              <option value="0" selected>Buy BitBay</option>
              <option value="1">Buy BitBay Reserve</option>
              <option value="2">Sell BitBay</option>
              <option value="3">Sell BitBay Reserve</option>
            </select>
            <br>
            <br>
          </div>

          <!--liquidity panel-->
          <div class="tabs__panel liquidity_panel">

            <div class="swapBody">
              <div class="swapFields">
                <div class="boxTitle swapFirstCoinTxt">Liquidity</div>

                <div class="swapField swapFlexColumn">
                  <div class=" swapFlexColumn">
                    Amount to add: 

                    <div class="input-group">
                      <input class="textBox form_field" id="Coin1amount" type="text" placeholder="0" required/>

                      <select id="Coin1" class="btn-inside"></select>
                    </div>
                  </div>

                  <br>
                  
                  <div class=" swapFlexColumn">
                    Amount to add: 

                    <div class="input-group">
                      <input class="textBox form_field" id="Coin2amount" type="text" placeholder="0" required/>

                      <select id="Coin2" class="btn-inside">
                        <option value="0">BitBay Liquid</option>
                        <option value="1">BitBay Reserve</option>
                      </select>
                    </div>
                  </div>

                  <div class=" swapFlexColumn">
                    <div class="callout hidden"><p id="addliquidtext"></p></div>
                    <br>
                    <div class="swapSelector swapFlexRow center btn" onclick="addLiquidity()">Add Liquidity</div>
                    <hr>
                    <div class="callout logged-in">
                      Additional info:<hr>
                      <div id="additionalCoins"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <br>
            
            <div class="boxTitle swapFirstCoinTxt">
              Widthdraw LP tokens/coins
            </div>

<div class="swapField swapFlexColumn withdraw">
          <div class="swapField-child swapFlexRow">
            <div class="swapFirstCoin swapSelector btn" onclick="CalculateBalance()">
              Œ£
              <div class="swapSelectorText">Calculate Balance</div>

            </div>
            <input class="swapTextInput" type="text" placeholder="0.0" id="WithdrawAmount" required="">
          </div>

          <div class="swapFlexColumn">
            
            <div class="swapSelector swapFlexRow center btn" onclick="withdrawLP()">üí∏ Withdraw LP tokens/coins</div>
          </div>

          <div class="swapFlexColumn">
            <div class="callout logged-in">
              Withdrawal Details:<hr>
              <div id="LPdetails1"></div>
            </div>
          </div>

        </div>
            <br><br>
            <div class="callout callout-success logged-in">
              Pool Liquidity details:<hr>
              <div id="LPdetails2"></div>
            </div>            
            <br>
            <!-- Liquidity charts -->
            <div class="swapBody">
            <div class="swapFields">
              <div class="boxTitle ">
                üìä Show Liquid/Reserve Chart
              </div>
            </div>
            <div class="swapField info_chart">          
              <span class="btn swapSelector" onclick="showPegChart(9)" id="showPegChartLiquidity">Show Liquid/Reserve Chart üìä</span>
              <br>
              <div class="chart_inputs hidden" id="chartContainer2Inputs">
                <div class="chart-slider-container">
                  <div class="style-2 wrapper m-b-50 p-l-r">
                    <div class="slider-keypress-liquidity m-b-20"></div>
                    <input type="text" class="input-with-keypress-3" id="range3" required>
                    <input type="text" class="input-with-keypress-4" id="range4" required>
                  </div>
                </div>
              </div>
              <br>
              <select id="ChartSelect">
              <option value="0">Show chart for selected pair</option>
              <option value="1">Show chart for my balance at the pool</option>
              </select>
              <br>
              <div id="chartContainer2" class=" hidden" style="height: 150px; border: 5px solid #d9dbda; border-radius: 10px"></div>
        </div>
      </div>
            <br>
          </div>

          <!--bridge panel-->
          <div class="tabs__panel">

            <div class="swapBody">
  <div class="swapFields">
        <div class="boxTitle swapFirstCoinTxt">
          Mint/Redeem Coins from BitBay
        </div>

        <div class="swapField">
          <div class="swapFirstCoin swapSelector btn" onclick="mintFromBitBay(document.getElementById('jsonproof').value)">
            <img class="swapSelectorLogo" src="./icon.png">
            <div class="swapSelectorText">Mint</div>

          </div>
          <input class="swapTextInput" type="text" placeholder="Merkle proof receipt" id="jsonproof" required>
        </div>

        <div class="boxTitle swapSecondCoinTxt">
          Register BitBay address for burn(bridge)
        </div>
        <div class="swapField">
          <div class="swapSecondCoin swapSelector btn" onclick="registerBitBay(document.getElementById('myBAYaddy').value)">
            üë®
            <div class="swapSelectorText">Register</div>

          </div>
          <input class="swapTextInput" type="text" placeholder="BitBay Address" id="myBAYaddy" required>
        </div>

        <div class="boxTitle swapSecondCoinTxt">
          Burn coins back to BitBay
        </div>
        <div class="swapField bridgeBurn">
          <div class="swapField-child">
            <div class="swapSecondCoin swapSelector btn" onclick="burnToBitBay(document.getElementById('myBAYamount').value)">
              üî•
              <div class="swapSelectorText">Burn</div>

            </div>
          </div>

          <div class="swapField-child">
            <input class="swapTextInput" type="text" placeholder="0.0" id="myBAYamount" required>
          </div>

          <div class="swapField-child">
            <div class="switch-field">
              <input type="radio" id="radio-burn-reserve" name="burn-liquid-reserve" value="Reserve Coins" checked/>
              <label for="radio-burn-reserve">Reserve Coins</label>
              <input type="radio" id="radio-burn-liquid" name="burn-liquid-reserve" value="Liquid Coins" />
              <label for="radio-burn-liquid">Liquid Coins</label>
            </div>
          </div>

        </div>

          <select id="coinToBurn" class="hidden">
            <option>Reserve Coins</option>
            <option>Liquid Coins</option>
          </select>

        <br>
        <hr>
        <div class="boxTitle swapSecondCoinTxt">
          Show my receipts/proofs for redeeming
        </div>
        <div class="swapField bridgeBurn show_receipt">

          <div class="input-group">
                
                <div id="merkleintro" class="swapSelector btn btn btn-inside btn-inside-start" onclick="showNonces()">‚Üí Show next receipt</div>
                <button type="button" class="swapSelector btn btn-inside" onclick="copyNonce()">üìÑ Copy</button>
            </div>
            <div id="merkletext" class="swapField-child callout hidden">
            </div>
        </div>
    </div>
</div>
          </div>
        </div>
        <div class="tabs tabs_overlay logged-in logged-in-remove hidden">
          
        </div>
        <div class="tabs tabs_overlay_message logged-in logged-in-remove ">
          <div class="callout callout-warning">Please log in with Metamask. If you don't have the extension you can download it for your browser from the <a href="https://metamask.io/download/" target="_blank">official source</a>.</div>
        </div>

      </div>
    </div>
  </div>
  <!-- partial -->

</div>

<!-- MODALS -->

<!-- Swap Buy Select -->
<div id="modal-swap-buy" class="modal fade" tabindex="-1" role="dialog">
 <div class="modal-dialog modal-dialog-small">
  <div class="modal-content">
   <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
     <span aria-hidden="true">√ó</span>
    </button>
    <h4 class="modal-title">Select a token</h4>
   </div>
   <div class="modal-body">
    <table class="table custom-table">
     <tbody>
      <tr scope="row" data-coin="BAY" data-cointext="Buy BitBay">
       <td>
        <i class="icon bay">
         <img src="./icon.png" />
        </i>
       </td>
       <td>Buy BitBay <small class="d-block">BitBay Liquid</small></td>
       <td>
        <label for="sdb1">
         <input type="radio" id="sdb1" name="b-swap-group" checked value="0" />
        </label>
       </td>
      </tr>
      <tr class="activea" data-coin="BAYR" data-cointext="Buy BitBay Reserve">
       <td>
        <i class="icon bay">
         <img src="./icon.png" />
        </i>
       </td>
       <td>Buy BitBay Reserve <small class="d-block">BitBay Reserve</small></td>
       <td>
        <label for="sdb2">
         <input type="radio" id="sdb2" name="b-swap-group" value="1" />
        </label>
       </td>
      </tr>
      <tr data-coin="BAY" data-cointext="Sell BitBay">
       <td>
        <i class="icon bay">
         <img src="./icon.png" />
        </i>
       </td>
       <td>Sell BitBay <small class="d-block">BitBay Liquid</small></td>
       <td>
        <label for="sdb3">
         <input type="radio" id="sdb3" name="b-swap-group" value="2" />
        </label>
       </td>
      </tr>
      <tr data-coin="BAYR" data-cointext="Sell BitBay Reserve">
       <td>
        <i class="icon bay">
         <img src="./icon.png" />
        </i>
       </td>
       <td>Sell BitBay Reserve <small class="d-block">BitBay Reserve</small></td>
       <td>
        <label for="sdb4">
         <input type="radio" id="sdb4" name="b-swap-group" value="3" />
        </label>
       </td>
      </tr>
     </tbody>
    </table>
   </div>
  </div>
  <!-- /.modal-content -->
 </div>
 <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<!-- Swap in exchange for Select -->
<div id="modal-swap-inexchange-for" class="modal fade" tabindex="-1" role="dialog">
 <div class="modal-dialog modal-dialog-small">
  <div class="modal-content">
   <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
     <span aria-hidden="true">√ó</span>
    </button>
    <h4 class="modal-title">Select a token</h4>
   </div>
   <div class="modal-body">
    <table class="table custom-table">
     <tbody>
      <tr scope="row">
       <td>
        <i class="icon bay">
         <img src="./walrus.png" />
        </i>
       </td>
       <td><br>In exchange for:
            <select id="SwapCoin2" >
            </select>
          </td>
       <td>
       </td>
      </tr>
      
     </tbody>
    </table>
   </div>
  </div>
  <!-- /.modal-content -->
 </div>
 <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<!-- scripts -->
<script type="text/javascript" src="./assets/js/nouislider.min.js"></script>
<script type="text/javascript" src="./assets/js/kane-modal.js"></script>

<script type="text/javascript" src="./assets/js/script.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/web3.min.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/bignumber.min.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/merkletree.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/BAYL.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/BAYR.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/BAYF.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/BAYData.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/LiquidityPool.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/BAYAdmin.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/Router.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/Router2.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/ERC20.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/Factory.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/Pair.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/WETH.js"></script>

<script type="text/javascript" src="./assets/js/bridge-tools/coin.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/crypto-sha256.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/jsbn.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/chartist.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/chartist-plugin-tooltip.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/purify.js"></script>
<script type="text/javascript" src="./assets/js/bridge-tools/sweetalert211.js"></script>

<style>
  .swal2-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 1.8em; }

  .swal2-title {
    position: relative;
    max-width: 100%;
    margin: 0 0 0.4em;
    padding: 0;
    color: #595959;
    font-size: 1.875em;
    font-weight: 600;
    text-align: center;
    text-transform: none;
    word-wrap: break-word; }

  .swal2-actions {
    display: flex;
    z-index: 1;
    box-sizing: border-box;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin: 1.25em auto 0;
    padding: 0; }
    .swal2-actions:not(.swal2-loading) .swal2-styled[disabled] {
      opacity: .4; }
    .swal2-actions:not(.swal2-loading) .swal2-styled:hover {
      background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)); }
    .swal2-actions:not(.swal2-loading) .swal2-styled:active {
      background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)); }

  .swal2-loader {
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.2em;
    height: 2.2em;
    margin: 0 1.875em;
    -webkit-animation: swal2-rotate-loading 1.5s linear 0s infinite normal;
            animation: swal2-rotate-loading 1.5s linear 0s infinite normal;
    border-width: 0.25em;
    border-style: solid;
    border-radius: 100%;
    border-color: #2778c4 transparent #2778c4 transparent; }

  .swal2-styled {
    margin: 0.3125em;
    padding: 0.625em 1.1em;
    box-shadow: none;
    font-weight: 500; }
    .swal2-styled:not([disabled]) {
      cursor: pointer; }
    .swal2-styled.swal2-confirm {
      border: 0;
      border-radius: 0;
      background: initial;
      background-color: #2778c4;
      color: #fff;
      font-size: 1em; }
    .swal2-styled.swal2-deny {
      border: 0;
      border-radius: 0.25em;
      background: initial;
      background-color: #d14529;
      color: #fff;
      font-size: 1em; }
    .swal2-styled.swal2-cancel {
      border: 0;
      border-radius: 0;
      background: initial;
      background-color: #757575;
      color: #fff;
      font-size: 1em; }
    .swal2-styled:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(100, 150, 200, 0.5); }
    .swal2-styled::-moz-focus-inner {
      border: 0; }

  .swal2-footer {
    justify-content: center;
    margin: 1.25em 0 0;
    padding: 1em 0 0;
    border-top: 1px solid #eee;
    color: #545454;
    font-size: 1em; }

  .swal2-timer-progress-bar-container {
    position: absolute;
    right: 0;
    bottom: 0;
    left: 0;
    height: 0.25em;
    overflow: hidden;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0; }

  .swal2-timer-progress-bar {
    width: 100%;
    height: 0.25em;
    background: rgba(0, 0, 0, 0.2); }

  .swal2-image {
    max-width: 100%;
    margin: 1.25em auto; }

  .swal2-close {
    position: absolute;
    z-index: 2;
    top: 0;
    right: 0;
    align-items: center;
    justify-content: center;
    width: 1.2em;
    height: 1.2em;
    padding: 0;
    overflow: hidden;
    transition: initial;
    border: none;
    border-radius: 5px;
    background: transparent;
    color: #cccccc;
    font-family: serif;
    font-size: 2.5em;
    line-height: 1.2;
    cursor: pointer; }
    .swal2-close:hover {
      transform: none;
      background: transparent;
      color: #f27474; }
    .swal2-close:focus {
      outline: none;
      box-shadow: inset 0 0 0 3px rgba(100, 150, 200, 0.5); }
    .swal2-close::-moz-focus-inner {
      border: 0; }

  .swal2-content {
    z-index: 1;
    justify-content: center;
    margin: 0;
    padding: 0 1.6em;
    color: #545454;
    font-size: 1.125em;
    font-weight: normal;
    line-height: normal;
    text-align: center;
    word-wrap: break-word; }

  .swal2-input,
  .swal2-file,
  .swal2-textarea,
  .swal2-select,
  .swal2-radio,
  .swal2-checkbox {
    margin: 1em auto; }

  .swal2-input,
  .swal2-file,
  .swal2-textarea {
    box-sizing: border-box;
    width: 100%;
    transition: initial;
    border: 1px solid #d9d9d9;
    border-radius: 0;
    background: inherit;
    box-shadow: none;
    color: inherit;
    font-size: 1.125em; }
    .swal2-input.swal2-inputerror,
    .swal2-file.swal2-inputerror,
    .swal2-textarea.swal2-inputerror {
      border-color: #f27474 !important;
      box-shadow: 0 0 2px #f27474 !important; }
    .swal2-input:focus,
    .swal2-file:focus,
    .swal2-textarea:focus {
      border: 1px solid #b4dbed;
      outline: none;
      box-shadow: 0 0 0 3px rgba(100, 150, 200, 0.5); }
    .swal2-input::-moz-placeholder, .swal2-file::-moz-placeholder, .swal2-textarea::-moz-placeholder {
      color: #7e7e7e; }
    .swal2-input:-ms-input-placeholder, .swal2-file:-ms-input-placeholder, .swal2-textarea:-ms-input-placeholder {
      color: #7e7e7e; }
    .swal2-input::placeholder,
    .swal2-file::placeholder,
    .swal2-textarea::placeholder {
      color: #7e7e7e; }

  .swal2-range {
    margin: 1em auto;
    background: #fff; }
    .swal2-range input {
      width: 80%; }
    .swal2-range output {
      width: 20%;
      color: inherit;
      font-weight: 600;
      text-align: center; }
    .swal2-range input,
    .swal2-range output {
      height: 2.625em;
      padding: 0;
      font-size: 1.125em;
      line-height: 2.625em; }

  .swal2-input {
    height: 2.625em;
    padding: 0 0.75em; }
    .swal2-input[type='number'] {
      max-width: 10em; }

  .swal2-file {
    background: inherit;
    font-size: 1.125em; }

  .swal2-textarea {
    height: 6.75em;
    padding: 0.75em; }

  .swal2-select {
    min-width: 50%;
    max-width: 100%;
    padding: .375em .625em;
    background: inherit;
    color: inherit;
    font-size: 1.125em; }

  .swal2-radio,
  .swal2-checkbox {
    align-items: center;
    justify-content: center;
    background: #fff;
    color: inherit; }
    .swal2-radio label,
    .swal2-checkbox label {
      margin: 0 .6em;
      font-size: 1.125em; }
    .swal2-radio input,
    .swal2-checkbox input {
      margin: 0 .4em; }

  .swal2-input-label {
    display: flex;
    justify-content: center;
    margin: 1em auto; }

  .swal2-validation-message {
    max-width: 90%;
    margin: 0; /* Adjusted to avoid overlap issues */
    padding: 0.625em;
    overflow: hidden;
    background: #f0f0f0;
    color: #545454;
    font-size: 1em;
    font-weight: 300;
    text-align: center; /* Center content horizontally */
    box-sizing: border-box; /* Ensure padding doesn‚Äôt cause overflow */
  }

  .swal2-validation-message::before {
    max-width: 90%;
    content: '!';
    display: inline-block;
    width: 1.5em;
    height: 1.5em;
    margin: 0 0.625em;
    border-radius: 50%;
    background-color: #f27474;
    color: #fff;
    font-weight: 600;
    line-height: 1.5em;
    text-align: center;
  }

  .swal2-icon {
    position: relative;
    box-sizing: content-box;
    justify-content: center;
    width: 5em;
    height: 5em;
    margin: 1.25em auto 1.875em;
    border: 0.25em solid transparent;
    border-radius: 50%;
    border-color: #000;
    font-family: inherit;
    line-height: 5em;
    cursor: default;
    -webkit-user-select: none;
       -moz-user-select: none;
        -ms-user-select: none;
            user-select: none; }
    .swal2-icon .swal2-icon-content {
      display: flex;
      align-items: center;
      font-size: 3.75em; }
    .swal2-icon.swal2-error {
      border-color: #f27474;
      color: #f27474; }
      .swal2-icon.swal2-error .swal2-x-mark {
        position: relative;
        flex-grow: 1; }
      .swal2-icon.swal2-error [class^='swal2-x-mark-line'] {
        display: block;
        position: absolute;
        top: 2.3125em;
        width: 2.9375em;
        height: .3125em;
        border-radius: .125em;
        background-color: #f27474; }
        .swal2-icon.swal2-error [class^='swal2-x-mark-line'][class$='left'] {
          left: 1.0625em;
          transform: rotate(45deg); }
        .swal2-icon.swal2-error [class^='swal2-x-mark-line'][class$='right'] {
          right: 1em;
          transform: rotate(-45deg); }
    .swal2-icon.swal2-warning {
      border-color: #facea8;
      color: #f8bb86; }
    .swal2-icon.swal2-info {
      border-color: #9de0f6;
      color: #3fc3ee; }
    .swal2-icon.swal2-question {
      border-color: #c9dae1;
      color: #87adbd; }
    .swal2-icon.swal2-success {
      border-color: #a5dc86;
      color: #a5dc86; }
      .swal2-icon.swal2-success [class^='swal2-success-circular-line'] {
        position: absolute;
        width: 3.75em;
        height: 7.5em;
        transform: rotate(45deg);
        border-radius: 50%; }
        .swal2-icon.swal2-success [class^='swal2-success-circular-line'][class$='left'] {
          top: -.4375em;
          left: -2.0635em;
          transform: rotate(-45deg);
          transform-origin: 3.75em 3.75em;
          border-radius: 7.5em 0 0 7.5em; }
        .swal2-icon.swal2-success [class^='swal2-success-circular-line'][class$='right'] {
          top: -.6875em;
          left: 1.875em;
          transform: rotate(-45deg);
          transform-origin: 0 3.75em;
          border-radius: 0 7.5em 7.5em 0; }
      .swal2-icon.swal2-success .swal2-success-ring {
        position: absolute;
        z-index: 2;
        top: -.25em;
        left: -.25em;
        box-sizing: content-box;
        width: 100%;
        height: 100%;
        border: 0.25em solid rgba(165, 220, 134, 0.3);
        border-radius: 50%; }
      .swal2-icon.swal2-success .swal2-success-fix {
        position: absolute;
        z-index: 1;
        top: .5em;
        left: 1.625em;
        width: .4375em;
        height: 5.625em;
        transform: rotate(-45deg); }
      .swal2-icon.swal2-success [class^='swal2-success-line'] {
        display: block;
        position: absolute;
        z-index: 2;
        height: .3125em;
        border-radius: .125em;
        background-color: #a5dc86; }
        .swal2-icon.swal2-success [class^='swal2-success-line'][class$='tip'] {
          top: 2.875em;
          left: .8125em;
          width: 1.5625em;
          transform: rotate(45deg); }
        .swal2-icon.swal2-success [class^='swal2-success-line'][class$='long'] {
          top: 2.375em;
          right: .5em;
          width: 2.9375em;
          transform: rotate(-45deg); }

  .swal2-progress-steps {
    flex-wrap: wrap;
    align-items: center;
    max-width: 100%;
    margin: 0 0 1.25em;
    padding: 0;
    background: inherit;
    font-weight: 600; }
    .swal2-progress-steps li {
      display: inline-block;
      position: relative; }
    .swal2-progress-steps .swal2-progress-step {
      z-index: 20;
      flex-shrink: 0;
      width: 2em;
      height: 2em;
      border-radius: 2em;
      background: #2778c4;
      color: #fff;
      line-height: 2em;
      text-align: center; }
      .swal2-progress-steps .swal2-progress-step.swal2-active-progress-step {
        background: #2778c4; }
        .swal2-progress-steps .swal2-progress-step.swal2-active-progress-step ~ .swal2-progress-step {
          background: #add8e6;
          color: #fff; }
        .swal2-progress-steps .swal2-progress-step.swal2-active-progress-step ~ .swal2-progress-step-line {
          background: #add8e6; }
    .swal2-progress-steps .swal2-progress-step-line {
      z-index: 10;
      flex-shrink: 0;
      width: 2.5em;
      height: .4em;
      margin: 0 -1px;
      background: #2778c4; }

  /* Custom Swal */
  .swal2-popup {
    position: fixed;
    background-color: #ededed; /* Background color */
    color: #000000; /* Text color */
    border: 2px solid #3d0064; /* Border color */
    border-radius: 4px; /* Border radius */
    font-size: 11px;
    font-family: 'Courier New', monospace; /* Custom font */
    font-weight: normal;
    z-index: 1000;
    transform: none;
    transition: none;
    animation: none;
    padding: 1.25em;
    width: 32em;
    box-sizing: border-box;
    flex-direction: column;
    justify-content: center;
  }
  .swal2-popup:focus {
    outline: none; }
  .swal2-popup.swal2-loading {
    overflow-y: hidden; }
  .swal2-title {
    color: #3d0064; /* Title text color */
  }
  .swal2-content {
    color: #3d0064; /* Content text color */
  }
  .swal2-confirm,
  .swal2-cancel {
    background-color: #ededed; /* Confirm and cancel button background color */
    color: #3d0064; /* Button text color */
  }
  /* Hover effect for buttons */
  .swal2-confirm:hover,
  .swal2-cancel:hover {
    background-color: #0086e3;
  }
  /* Icon color */
  .swal2-icon {
    color: #3d0064;
  }
  .swal2-range {
    background-color: #ededed; /* Set your desired background color */
    border: 2px solid #3d0064;
  }
  .scrollable-swal-popup {
    max-height: 80vh; /* Prevents the modal from overflowing vertically */
    overflow-y: auto; /* Enables scrolling within the modal */
  }
</style>

<script type="text/javascript">

//For further security improvements to these tools it's possible to add a
//section which allows a custom approval where users can set manually or
//possibly have a dialog box move into focus when asked for the authorization
//which lets them specify the amount. Also in the security tab advise users
//on how to run the page locally.

function centerPopup() {
    const popup = Swal.getPopup();
    if (!popup) return;

    // Ensure it's fixed to the viewport
    popup.style.position = 'fixed';

    const rect = popup.getBoundingClientRect();

    const top = (window.innerHeight - rect.height) / 2;
    const left = (window.innerWidth - rect.width) / 2;

    popup.style.top = `${top}px`;
    popup.style.left = `${left}px`;
}
Swal = Swal.mixin({
    showClass: {
        popup: '' // Disable show animation
    },
    hideClass: {
        popup: '' // Disable hide animation
    },
    didRender: () => {
        // Call the center function when the popup opens
        setTimeout(centerPopup, 5);
    }
});

let spinnerElement;

function showSpinner() {
    hideSpinner(); // Ensure no duplicate spinners

    // Create the spinner container
    spinnerElement = document.createElement('div');
    spinnerElement.style.position = 'fixed';
    spinnerElement.style.top = '50%';
    spinnerElement.style.left = '50%';
    spinnerElement.style.transform = 'translate(-50%, -50%)';
    spinnerElement.style.width = '50px';
    spinnerElement.style.height = '50px';
    spinnerElement.style.border = '5px solid transparent';
    spinnerElement.style.borderTopColor = '#5D2F8E';
    spinnerElement.style.borderRadius = '50%';
    spinnerElement.style.animation = 'spin 1s linear infinite';
    spinnerElement.style.zIndex = '99';
    spinnerElement.style.cursor = 'pointer';

    // Inner hourglass look
    const innerElement = document.createElement('div');
    innerElement.style.position = 'absolute';
    innerElement.style.top = '5px';
    innerElement.style.left = '5px';
    innerElement.style.right = '5px';
    innerElement.style.bottom = '5px';
    innerElement.style.border = '5px solid transparent';
    innerElement.style.borderBottomColor = '#5D2F8E';
    innerElement.style.borderRadius = '50%';
    spinnerElement.appendChild(innerElement);

    document.body.appendChild(spinnerElement);

    // Only create keyframes once
    if (!document.getElementById('spinner-style')) {
        const style = document.createElement('style');
        style.id = 'spinner-style';
        style.innerHTML = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }

    // Delay event listeners to avoid instant hide on initial click
    setTimeout(() => {
        try {
          spinnerElement.addEventListener("click", hideSpinner);
          spinnerElement.addEventListener("touchstart", hideSpinner);
        } catch {         
        }
    }, 100);
}

function hideSpinner() {
    try {
      if (spinnerElement) {
          spinnerElement.remove();
          spinnerElement = null;
      }
    } catch {      
    }
}

var lastTouchY = 0;
var preventPullToRefresh = false;
window.document.body.addEventListener("touchstart", function(e){
    if (e.touches.length != 1) { return; }
    lastTouchY = e.touches[0].clientY;
    preventPullToRefresh = window.pageYOffset == 0;
}, false);

window.document.body.addEventListener("touchmove", function(e){
    var touchY = e.touches[0].clientY;
    var touchYDelta = touchY - lastTouchY;
    lastTouchY = touchY;
    if (preventPullToRefresh) {
        // To suppress pull-to-refresh it is sufficient to preventDefault the first overscrolling touchmove.
        preventPullToRefresh = false;
        if (touchYDelta > 0) {
            e.preventDefault();
            return;
        }
    }
}, { passive: false });

function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

    // Detect language
var merkleProof = getQueryParam('m') || '';  // Default to 'en' if not provided
if(merkleProof != '') {
  document.getElementById("jsonproof").value = merkleProof;
  Swal.fire({
    icon: 'success',
    title: 'Receipt pending',
    text: 'The site has detected a merkle proof in the URL. The text was filled into the minting form. Once logged in, you can attempt to redeem it by clicking "Mint".',
  });
}


var web3 = [];
var contractInst = [];
var gasPrice;
//web3[0] = new Web3("https://cloudflare-eth.com");
//web3[1] = new Web3("https://bsc-dataseed.binance.org");
//web3[2] = new Web3("https://api-goerli.etherscan.io/");
//web3[3] = new Web3("https://polygon-mainnet.public.blastapi.io");
var isConnected = false;
window.addEventListener('ethereum#initialized', login, {
    once: true,
});

window.addEventListener('keyup', calculateDeposit, {
});

window.addEventListener("load", async function() {
  if (window.ethereum) {
    // detect Metamask account change
    window.ethereum.on('accountsChanged', async function (newaccounts) {
      console.log('accountsChanges',newaccounts);
      defaultvars();
      await login();
    });
     // detect Network account change
    window.ethereum.on('chainChanged', async function(thenetworkId){
      console.log('chainChanged',thenetworkId);
      defaultvars();
      await login();
    });
  }
});

document.getElementById('Coin2').addEventListener('change', async function() {
    autocompute = 0;
    lastchecked = 0;
    reservebayval3 = 0;
    reservecoinval3 = 0;    
    LPtokens = 0;
    mycurrentpair = '';
    reserveatpool = [];
    prevresult = [];
    prevtime = 0;
    prevselect = 10;
    document.getElementById("LPdetails1").innerHTML = '';
    document.getElementById("LPdetails2").innerHTML = '';
    document.getElementById("WithdrawAmount").value = '';
    await getMarketData();
    document.getElementById("Coin1amount").value = '';
    document.getElementById("Coin2amount").value = '';
    document.getElementById("additionalCoins").innerHTML = '';
    calculateDeposit();    
});

document.getElementById('Coin1').addEventListener('change', async function() {
    autocompute = 0;
    lastchecked = 0;
    reservebayval3 = 0;
    reservecoinval3 = 0;    
    LPtokens = 0;
    mycurrentpair = '';
    reserveatpool = [];
    prevresult = [];
    prevtime = 0;
    prevselect = 10;
    document.getElementById("LPdetails1").innerHTML = '';
    document.getElementById("LPdetails2").innerHTML = '';
    document.getElementById("WithdrawAmount").value = '';
    await getMarketData();
    document.getElementById("Coin1amount").value = '';
    document.getElementById("Coin2amount").value = '';
    document.getElementById("additionalCoins").innerHTML = '';
    calculateDeposit();
});

document.getElementById('SwapCoin').addEventListener('change', function() {
    lastchecked2 = 0;
    reservebayval2 = 0;
    reservecoinval2 = 0;
    document.getElementById("SwapAmount").value = '';
    document.getElementById("SwapAmount2").value = '';
    document.getElementById("SwapSummary").innerHTML = '';
    calculateDeposit();
});
document.getElementById('SwapCoin2').addEventListener('change', function() {
    lastchecked2 = 0;
    reservebayval2 = 0;
    reservecoinval2 = 0;
    document.getElementById("SwapAmount").value = '';
    document.getElementById("SwapAmount2").value = '';
    document.getElementById("SwapSummary").innerHTML = '';
    calculateDeposit();
});

document.getElementById('exchangeSelect').addEventListener('change', async function() {
    autocompute = 0;
    lastchecked = 0;
    lastchecked2 = 0;
    reservebayval2 = 0;
    reservecoinval2 = 0;
    reservebayval3 = 0;
    reservecoinval3 = 0;
    LPtokens = 0;
    mycurrentpair = '';
    reserveatpool = [];
    prevresult = [];
    prevtime = 0;
    prevselect = 10;
    document.getElementById("LPdetails1").innerHTML = '';
    document.getElementById("LPdetails2").innerHTML = '';
    document.getElementById("WithdrawAmount").value = '';
    await getMarketData();
    document.getElementById("Coin1amount").value = '';
    document.getElementById("Coin2amount").value = '';
    document.getElementById("SwapAmount").value = '';
    document.getElementById("SwapAmount2").value = '';
    document.getElementById("SwapSummary").innerHTML = '';
    document.getElementById("additionalCoins").innerHTML = '';
    calculateDeposit();
});

document.getElementById('ChartSelect').addEventListener('change', async function() {
    prevresult = [];
    prevtime = 0;
    prevselect = 10;
});

async function login() {
    if (window.ethereum) { //Note: for mobile this only works if the webpage has <head> tag
      try {
          console.log("connecting");
          showSpinner();
          await window.ethereum.request({method: 'eth_requestAccounts'});
          web3 = new Web3(window.ethereum);
          console.log("success");

          var notLoggedinElements  = document.querySelectorAll('.not-logged-in');
          notLoggedinElements.forEach(el => {el.classList.add('hidden')});

          var authElements = document.querySelectorAll('.logged-in');
          authElements.forEach(el => {el.classList.remove('hidden');});

          //remove elements like overlay on box when logged in
          var authElementsRemove = document.querySelectorAll('.logged-in-remove');
          authElementsRemove.forEach(el => {el.parentNode.removeChild(el);});
          
          document.getElementById("merkletext").innerHTML = '';
          document.getElementById("addliquidtext").innerHTML = '';
          document.getElementById("Coin1amount").value = '';
          document.getElementById("Coin2amount").value = '';
          document.getElementById("SwapAmount").value = '';
          document.getElementById("SwapAmount2").value = '';
          document.getElementById("SwapSummary").innerHTML = '';

          gasPrice = "20000000000";
          await web3.eth.getGasPrice().then(function (theGasPrice) {
            gasPrice = window.web3.utils.toWei(parseInt(parseInt(DOMPurify.sanitize(theGasPrice)) * 1.5).toString(), 'wei');
            if (currentChainId == "1") {
              if(parseInt(gasPrice) > 500000000000) {
                gasPrice = "500000000000";
              }
              if(parseInt(gasPrice) < 250000000) {
                gasPrice = "250000000";
              }
            } else {
              if(parseInt(gasPrice) > 2500000000000) {
                gasPrice = "2500000000000";
              }
              if(parseInt(gasPrice) < 250000000) {
                gasPrice = "250000000";
              }
            }
            if (currentChainId == "137") {
              if(parseInt(gasPrice) > 500000000000) {
                gasPrice = "500000000000";
              }
              if(parseInt(gasPrice) < 250000000) {
                gasPrice = "250000000";
              }
            } else {
              if(parseInt(gasPrice) > 2500000000000) {
                gasPrice = "2500000000000";
              }
              if(parseInt(gasPrice) < 250000000) {
                gasPrice = "250000000";
              }
            }
          });
          lastitem = 10000000;
          isConnected = true;
          await checkbalances();
          makeFairRatio();
          hideSpinner();
        } catch (e) {
          hideSpinner()
          console.error("Await failed:", e.message);
          // Check if the error message contains '502 Bad Gateway'
          if (e.message.includes("502 Bad Gateway")) {              
              Swal.fire({
                  icon: 'error',
                  title: 'Issue connecting to MetaMask',
                  text: 'Please check the API/RPC or internet connection.',
                  confirmButtonText: 'Close'
              });
          }
          else if (e.message.includes("Rate limit exceeded") || e.message.includes("All retries exhausted")) {
              Swal.fire({
                  icon: 'warning',
                  title: 'Issue connecting to MetaMask',
                  text: 'Rate Limit Exceeded. You are making too many requests, please wait a while before trying again.',
                  confirmButtonText: 'Close'
              });
          }
          else {
              Swal.fire({
                  icon: 'error',
                  title: 'An error occurred',
                  text: 'Something went wrong. Please try again later.',
                  confirmButtonText: 'Close'
              });
          }
          console.error("Error stack:", e.stack);
        }
    } else {
        isConnected = false;
        modalDialog('Error', "Please log in with Metamask. If you don't have the extension you can download it for your browser from the <a href='https://metamask.io/download/' target='_blank'>official source</a>.", "warning");
    }
}


myaccounts = [];
baydatacontract = '';
baylcontract = '';
bayrcontract = '';
bayfcontract = '';
bayadmincontract = '';
liquiditypool = '';
networkvars = [];
reservetimelock = 2629800;
BAYAdmin = '';
currentChainId = '';
prevChainId = 0;
lastitem = 10000000;
pairs = [];
knowndecimals = [];
routers = [];
exchanges = [];
exchangenum = [];
exchangeImages = [];
BAYLaddy = '';
BAYRaddy = '';
fairRatio = [];
poolreserve = [];
lastchecked = 0;
lastchecked2 = 0;
lockthis = 0;
autocompute = 0;
reservebayval = 0;
reservecoinval = 0;
reservebayval2 = 0;
reservecoinval2 = 0;
reservebayval3 = 0;
reservecoinval3 = 0;
currentdecimals = 8;
currentdecimals2 = 8;
recommendedBAY = 0;
slippage = 0;
LPtokens = 0;
mycurrentpair = '';
reserveatpool = [];
prevresult = [];
prevtime = 0;
prevselect = 10;
precision = 5;
lastSelect = '';
lastMinMax = 0;
withdrawMin1 = 0;
withdrawMin2 = 0;
lastrun = 0;
const BN = BigNumber;
document.getElementById("CoinPercent").value = '10';
document.getElementById('SwapCoin').value = "0";
document.getElementById('SwapCoin2').value = "0";
var updates = "";

function defaultvars() {
    myaccounts = [];
    baydatacontract = '';
    baylcontract = '';
    bayrcontract = '';
    bayfcontract = '';
    bayadmincontract = '';
    liquiditypool = '';
    networkvars = [];
    reservetimelock = 2629800;
    BAYAdmin = '';
    currentChainId = '';
    prevChainId = 0;
    lastitem = 10000000;
    pairs = [];
    knowndecimals = [];
    routers = [];
    exchanges = [];
    exchangenum = [];
    exchangeImages = [];
    BAYLaddy = '';
    BAYRaddy = '';
    fairRatio = [];
    poolreserve = [];
    lastchecked = 0;
    lastchecked2 = 0;
    autocompute = 0;
    reservebayval = 0;
    reservecoinval = 0;
    reservebayval2 = 0;
    reservecoinval2 = 0;
    reservebayval3 = 0;
    reservecoinval3 = 0;
    currentdecimals = 8;
    currentdecimals2 = 8;
    recommendedBAY = 0;
    slippage = 0;
    LPtokens = 0;
    mycurrentpair = '';
    reserveatpool = [];
    prevresult = [];
    prevtime = 0;
    prevselect = 10;
    precision = 5;
    lastSelect = '';
    lastMinMax = 0;
    withdrawMin1 = 0;
    withdrawMin2 = 0;
    document.getElementById('Coin1').value = "0";
    document.getElementById("Coin1").selectedIndex = 0;
    document.getElementById('Coin2').value = "0";
    document.getElementById("Coin2").selectedIndex = 0;
    document.getElementById("Coin1amount").value = '';
    document.getElementById("Coin2amount").value = '';
    document.getElementById("CoinPercent").value = '10';
    //document.getElementById("text1").innerHTML = '';
    document.getElementById("networkinfo").innerHTML = '';
    document.getElementById("additionalCoins").innerHTML = '';
    
    document.getElementById("merkletext").innerHTML = '';
    document.getElementById("addliquidtext").innerHTML = '';    
    document.getElementById('SwapCoin').value = "0";
    document.getElementById("SwapCoin").selectedIndex = 0;
    document.querySelector('input[name="b-swap-group"][value="0"]').checked = true;
    document.getElementById('SwapCoin2').value = "0";
    document.getElementById("SwapCoin2").selectedIndex = 0;
    document.getElementById("SwapAmount").value = '';
    document.getElementById("SwapAmount2").value = '';
    document.getElementById("SwapSummary").innerHTML = '';
    document.getElementById("LPdetails1").innerHTML = '';
    document.getElementById("LPdetails2").innerHTML = '';
    document.getElementById("WithdrawAmount").value = '';
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelector('input[name="b-swap-group"][value="0"]').checked = true;
});

function stripZeros(valStr) {
  return valStr.includes('.')
    ? valStr.replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.0+$/, '')
    : valStr;
}

async function checkbalances() {
    if (!isConnected) {
        return;
    }
    var myaccounts2 = await web3.eth.getAccounts();
    if (myaccounts2.length == 0) {
        //document.getElementById("text1").innerHTML = "Please unlock Metamask so it can connect.";
        modalDialog('Connect', "Please unlock Metamask so it can connect.", "warning");
        return;
    }
    lastchecked = 0;
    lastchecked2 = 0;
    currentChainId = await web3.eth.net.getId();
    var pegsteps;
    var microsteps;
    var deflationrate;
    var compoundrate;
    var netname = "unknown";
    var netname2 = "ETH";
    if (currentChainId == "11155111") {
        document.getElementById("current-network").innerHTML = "Sepolia Testnet";        
        netname = "Sepolia Testnet";
        netname2 = "ETH";
        BAYLaddy = "0x009A9691B789b3E3082f727CD32130E1fdEEb618";
        BAYRaddy = "0xf604023990b3f9b865692D6f2877d4d0B92828A5";
        BAYFaddy = "0x1285c146B0F38fe745A76B3966e38439d963e0f6";
        BAYDataAddy = "0xbfd49f391E109A5A528F6a654A0cB8e8cBA597D4";
        BAYAdmin = "0x6792F14fAD6bd4179f8E34Af9B786C577b83e15B";
        liquidityAddy = "0x1C142996D978C6381744e26516c65D3C09c87a5D";
        pegsteps = 30;
        microsteps = 8;
        deflationrate = 99;
        compoundrate = 5;
        reservetimelock = 600; //Testnet is 10 minutes
    }
    if (currentChainId == "137") {
        document.getElementById("current-network").innerHTML = "Polygon";
        netname = "Polygon";
        netname2 = "POL";
        BAYLaddy = "0x05aB92a131A489e23bE8eBA829F3986D72af6A2E";
        BAYRaddy = "0x8Ec52157Eb32aA9cb88a0a503aaac3641291d419";
        BAYFaddy = "0x26948f011942B539897f98f99288C340291993c2";
        BAYDataAddy = "0xA9BF89b0c130Fc8FA9838d923f81d51325909045";
        BAYAdmin = "0xf98eA1C9841cD1B4433cE3a1f0ad2BEa3406af7E";
        liquidityAddy = "0x88FBe58291B78C90c361cdc1D1f5dD13b252e5e2";
        pegsteps = 30;
        microsteps = 8;
        deflationrate = 99;
        compoundrate = 5;
        reservetimelock = 2592000; //One month
    }    
    if (netname == "unknown") {
        //document.getElementById("text1").innerHTML = "Unsupported network";
        modalDialog('Connect', "Unsupported network.", "danger");
        return;
    }
    gasPrice = "20000000000";
    await web3.eth.getGasPrice().then(function (theGasPrice) {
      gasPrice = window.web3.utils.toWei(parseInt(parseInt(DOMPurify.sanitize(theGasPrice)) * 1.5).toString(), 'wei');
      if (currentChainId == "1") {
        if(parseInt(gasPrice) > 500000000000) {
          gasPrice = "500000000000";
        }
        if(parseInt(gasPrice) < 250000000) {
          gasPrice = "250000000";
        }
      } else {
        if(parseInt(gasPrice) > 2500000000000) {
          gasPrice = "2500000000000";
        }
        if(parseInt(gasPrice) < 250000000) {
          gasPrice = "250000000";
        }
      }
    });
    myaccounts = DOMPurify.sanitize(myaccounts2[0]);
    baydatacontract = new web3.eth.Contract(BAYDataAbi, BAYDataAddy)
    baylcontract = new web3.eth.Contract(BAYLabi, BAYLaddy);
    bayrcontract = new web3.eth.Contract(BAYRabi, BAYRaddy);
    bayfcontract = new web3.eth.Contract(BAYFabi, BAYFaddy);
    bayadmincontract = new web3.eth.Contract(BAYAdminAbi, BAYAdmin);
    liquiditypool = new web3.eth.Contract(LiquidityABI, liquidityAddy);
    var BAYLBal;
    var BAYRBal;
    var BAYFBal;
    BAYLBal = stripZeros((new BigNumber(DOMPurify.sanitize(await baylcontract.methods.balanceOf(myaccounts).call())).dividedBy('1e8')).toFixed());
    BAYRBal = stripZeros((new BigNumber(DOMPurify.sanitize(await bayrcontract.methods.balanceOf(myaccounts).call())).dividedBy('1e8')).toFixed());
    BAYFBal = stripZeros((new BigNumber(DOMPurify.sanitize(await bayfcontract.methods.balanceOf(myaccounts).call())).dividedBy('1e8')).toFixed());
    await window.web3.eth.getBalance(myaccounts, function(err, result1) {
        if (err) {
            console.log(err);
            return;
        } else {
            var ETHBalance = window.web3.utils.fromWei(DOMPurify.sanitize(result1), "ether");
            document.getElementById("balance_network").innerHTML = DOMPurify.sanitize("Current Network: "+ netname + "<br> Address: " + myaccounts + "<br>" + netname2 + " balance:" + ETHBalance + "<br>BAY Liquid:" + BAYLBal + "<br>BAY Reserve:" + BAYRBal + "<br>BAY Frozen:" + BAYFBal);
        //document.getElementById("text1").innerHTML = DOMPurify.sanitize("Current Network: "+ netname + "<br>" + myaccounts + "<br>" + netname2 + " balance:" + ETHBalance + "<br>BAY Liquid:" + BAYLBal + "<br>BAY Reserve:" + BAYRBal + "<br>BAY Frozen:" + BAYFBal);
        }
    })
    //await bayadmincontract.methods.isActive().call().then(function (isActive) { //May also check if automatic unfreeze and special transactions are enabled
    //    if(parseInt(DOMPurify.sanitize(isActive)) > 1) {            
    //        modalDialog('Connect', "NOTICE: Spending is currently disabled as this contract may be under maintenance.", "warning");
    //    }
    //})    
    try {
      var lastCheck = localStorage.getItem("lastDelayCheck");
      const now = Date.now();
      if (!lastCheck) {
        lastCheck = now;
      }
      if (((now - parseInt(lastCheck, 10)) > 60 * 60 * 1000) || parseInt(lastCheck) == parseInt(now)) {
        localStorage.setItem("lastDelayCheck", now.toString());
        const pos = parseInt(DOMPurify.sanitize(await bayadmincontract.methods.lastProxyPosition().call()));
        updates = DOMPurify.sanitize(JSON.parse(await bayadmincontract.methods.delayedChanges(pos).call()));
        console.log(updates);
      }
    } catch (e) {
      //This is expected to catch if no updates are incoming. List length is not available directly in the contract.
    }
    if(updates != "") {
      document.getElementById("balance_network").innerHTML += "<br><br>NOTICE: Contract updates are pending. Please check the delayed changes in the contract.";
    }
    document.getElementById("contractinfo").innerHTML = "Contracts to import into Metamask so that you may interact with BitBay: <br>BitBay - " +  BAYLaddy + "<br>BitBay Reserve - " + BAYRaddy + "<br>BitBay Frozen - " + BAYFaddy + "<br><br>";
    await getNetworkInfo();
    await getMarketData();
}

async function getNetworkInfo() {
    await baydatacontract.methods.getState().call().then(function (netvars) {
        networkvars = JSON.parse(DOMPurify.sanitize(JSON.stringify(netvars)));
    })
    document.getElementById("networkinfo").innerHTML = DOMPurify.sanitize("Current Total Network Supply: " + calculateSupply(networkvars[0],networkvars[4],networkvars[3]) + "% (" + networkvars[0] + " / " + (networkvars[1] * networkvars[2]) + ")<br>Peg compression(steps, microsteps): " + networkvars[1] + ", "+ networkvars[2] + "<br>Deflation rate and compound rate: (" + networkvars[4] + "% ^ " + (100 - networkvars[3]) + ")<br>Three way factor to BitBay's 1200 possible supplies: (" + networkvars[1] + " * " + networkvars[2] + " * " + (100 - networkvars[3]) + ")<br>Time delay for reserve payments(in seconds): " + reservetimelock);
}

async function getMarketData(calcbal = 0) {
    if (prevChainId == 0) {
        pairs = [];
        knowndecimals = [];
        routers = [];
        exchanges = [];
        exchangenum = [];
        exchangeImages = [];
        document.getElementById("exchangeImage").innerHTML="";
        document.getElementById("Coin1").innerHTML="";
        document.getElementById("exchangeSelect").innerHTML="";
    }
    var text = '';
    var x;
    if(prevChainId != currentChainId) {
        pairs = [];
        knowndecimals = [];
        routers = [];
        exchanges = [];
        exchangenum = [];
        exchangeImages = [];
        prevChainId = currentChainId;
        if (currentChainId == "11155111") {
            pairs.push({'Wrapped ETH': '0x15F6dD401774441D161D1722aF9e975F60A3cb7b'});
            pairs.push({'HappyWalrusCoin': '0xf7F8aB76E62983ec12D97fD026Ab11296EdB2e23'});
            knowndecimals.push(18);
            knowndecimals.push(8);
            exchanges.push({'WalrusSwap': '0xf99eaeEF749F99F826bF3c1150fCD64a0d0CE6EA'});
            exchangenum.push(997)
            exchangeImages.push('<img src="./walrus.png" style="height: 75px; width: 75px;"/>');
            routers.push({'UniversalRouter': '0xfe8f06a4435551c1ab93af0B12D12f4873114a09'});
        }
        if (currentChainId == "137") {
            pairs.push({'Wrapped ETH': '0x7ceb23fd6bc0add59e62ac25578270cff1b9f619'});
            pairs.push({'DAI': '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063'});
            knowndecimals.push(18);
            knowndecimals.push(18);
            exchanges.push({'UniSwap': '0x9e5A52f57b3038F1B8EeE45F28b3C1967e22799C'});
            exchangenum.push(997)
            exchangeImages.push('<img src="./uniswap.png" style="height: 75px; width: 75px;"/>');
            routers.push({'UniversalRouter': '0x794b0ECfA7ef2ed574a4a2eeba44824926f3ea29'});
        }        
        document.getElementById("exchangeImage").innerHTML="";
        document.getElementById("Coin1").innerHTML="";
        document.getElementById("exchangeSelect").innerHTML="";
        if(exchangeImages.length > 0) {
            document.getElementById("exchangeImage").innerHTML=exchangeImages[0];
        }
        text = '';
        x = 0; 
        while (x < pairs.length) {
            text += "<option value=" + x + ">" + Object.keys(pairs[x])[0] + "</option>";
            x += 1;
        }
        document.getElementById("Coin1").innerHTML=text;
        document.getElementById("SwapCoin2").innerHTML=text;
        text = '';
        x = 0; 
        while (x < exchanges.length) {
            text += "<option value=" + x + ">" + Object.keys(exchanges[x])[0] + "</option>";
            x += 1;
        }
        document.getElementById("exchangeSelect").innerHTML=text;
    }
    
    //console.log("Checking pool reserves...");
    var bayaddy = '';
    var coin1 = document.getElementById("Coin1").value;
    var currentdecimals3 = 8;
    currentdecimals3 = await getDecimals(coin1);
    coin1 = Object.values(pairs[coin1])[0];
    var exchange = document.getElementById("exchangeSelect").value;
    exchange = Object.values(exchanges[exchange])[0];
    var bayselect = document.getElementById("Coin2").value;   
    var totSupply = 0;
    var bayname = '';
    var bayname2 = '';
    if(bayselect == 0) {
        bayname = "BitBay";
        bayaddy = BAYLaddy;
        bayname2 = "BitBay Reserve";
    }
    if(bayselect == 1) {
        bayname = "BitBay Reserve";
        bayaddy = BAYRaddy;
        bayname2 = "BitBay";
    }
    await liquiditypool.methods.matchprecision().call().then(function (result3) {
        precision = parseInt(DOMPurify.sanitize(result3));
    })
    var exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
    await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (result3) {
        mycurrentpair = DOMPurify.sanitize(result3);
    });
    if(/^0x0+$/.test(mycurrentpair) == false) {
        var token0 = '';
        var reserves = [];
        var LPtokensPair;
        var paircontract = new web3.eth.Contract(PairABI, mycurrentpair);
        await paircontract.methods.getReserves().call().then(function (result3) {
            reserves = JSON.parse(DOMPurify.sanitize(JSON.stringify(result3)));
        });
        await paircontract.methods.token0().call().then(function (result3) {
            token0 = DOMPurify.sanitize(result3);
        });
        await paircontract.methods.totalSupply().call().then(function (result3) {
            totSupply = DOMPurify.sanitize(result3);
        });
        await liquiditypool.methods.LPtokens(myaccounts, mycurrentpair).call().then(function (result3) {
            LPtokens = DOMPurify.sanitize(result3);
        });
        await paircontract.methods.balanceOf(myaccounts).call().then(function (result3) {
            LPtokensPair = DOMPurify.sanitize(result3);
        });
        if (new BigNumber(LPtokensPair).lt(new BigNumber(LPtokens))) {
          LPtokens = LPtokensPair;
        }
        if(token0 == BAYLaddy || token0 == BAYRaddy) {
            reservebayval3 = new BigNumber(reserves[0]);
            reservecoinval3 = new BigNumber(reserves[1]);
        } else {
            reservebayval3 = new BigNumber(reserves[1]);
            reservecoinval3 = new BigNumber(reserves[0]);
        }

        coin1 = document.getElementById("Coin1").value;
        let myval1 = stripZeros(reservecoinval3.dividedBy(new BigNumber(10).pow(currentdecimals3)).toFixed(currentdecimals3));
        let myval2 = stripZeros(reservebayval3.dividedBy('1e8').toFixed(8));

        text = "Exchange details for the pair " + Object.keys(pairs[coin1]) + "/" + bayname + ":<br>";
        text += "Total coins available for " + Object.keys(pairs[coin1]) + ": " + myval1 + "<br>";
        text += "Total coins available for " + bayname + ": " + myval2 + "<br>";

        let otherbal;
        if(bayselect == 0) {
            otherbal = stripZeros(new BigNumber(web3.utils.fromWei(
                DOMPurify.sanitize(await bayrcontract.methods.balanceOf(mycurrentpair).call()),
                'gwei')).times(10).toFixed(8));
        } else {
            otherbal = stripZeros(new BigNumber(web3.utils.fromWei(
                DOMPurify.sanitize(await baylcontract.methods.balanceOf(mycurrentpair).call()),
                'gwei')).times(10).toFixed(8));
        }

        text += bayname2 + " coins overage at this pair: " + otherbal + "<br>";
        text += "Total LP token supply for this pair: " + totSupply + "<br>";
        text += "Your LP token balance for this pair: " + LPtokens + " (" + stripZeros(new BigNumber(LPtokens).dividedBy(totSupply).times(100).toFixed(5)) + "% of the pool)<br><br>";

        let text2 = "";
        if(calcbal == 1) {
            if(new BigNumber(LPtokens).gt(0)) {
                LPtokens2 = document.getElementById("WithdrawAmount").value.trim();
                if(LPtokens2 === '' || new BigNumber(LPtokens2).gt(new BigNumber(LPtokens))) {
                    text2 = LPtokens2 === ''
                        ? "Please enter the number of LP tokens you wish to calculate for<br><br>"
                        : "Amount requested exceeds balance<br><br>";
                } else {
                    await liquiditypool.methods.calculatePoolBalanceV1(myaccounts, mycurrentpair, 0, LPtokens2, precision, 0).call().then(function (result3) {
                        result3 = JSON.parse(DOMPurify.sanitize(JSON.stringify(result3)));
                        reserveatpool = result3[1];
                    });

                    let section = Math.floor(networkvars[0] / networkvars[2]);
                    let ak = Math.floor(networkvars[0] % networkvars[2]);

                    let resbal = new BigNumber(0);
                    let liqbal = new BigNumber(0);

                    for(let x = 0; x < networkvars[1]; x++) {
                        if(x < section) {
                            resbal = resbal.plus(new BigNumber(reserveatpool[x]));
                        } else {
                            liqbal = liqbal.plus(new BigNumber(reserveatpool[x]));
                        }
                    }

                    for(let j = 0; j < networkvars[2]; j++) {
                        let val = new BigNumber(reserveatpool[parseInt(networkvars[1]) + j]);
                        if(j < ak) {
                            resbal = resbal.plus(val);
                        } else {
                            liqbal = liqbal.plus(val);
                        }
                    }

                    myval1 = stripZeros(liqbal.dividedBy('1e8').toFixed(8));
                    myval2 = stripZeros(resbal.dividedBy('1e8').toFixed(8));
                    let myval3 = stripZeros(new BigNumber(LPtokens2).dividedBy(totSupply).times(reservecoinval3).dividedBy(new BigNumber(10).pow(currentdecimals3)).toFixed(currentdecimals3));

                    text2 += "Estimated BAY balance at pool: " + myval1 + "<br>";
                    text2 += "Estimated BAYR balance at pool: " + myval2 + "<br>";
                    text2 += "Estimated " + Object.keys(pairs[coin1]) + " balance at pool: " + myval3 + "<br><br>";
                }
            } else {
                text2 = "You have no balance at this pool<br><br>";
            }

            document.getElementById("LPdetails1").innerHTML = DOMPurify.sanitize(text2);
        }

        document.getElementById("LPdetails2").innerHTML = DOMPurify.sanitize(text);

    }
}

async function getDecimals(myobj) {
    if(knowndecimals.length != 0) {
        if(knowndecimals.length - 1 <= parseFloat(myobj)) {
            return knowndecimals[myobj];
        }
    }
    var thiscontract = new web3.eth.Contract(ERC20ABI, Object.values(pairs[myobj])[0]);
    var thedecimals = 0;
    await thiscontract.methods.decimals().call().then(function (dresult) {
        thedecimals = parseInt(DOMPurify.sanitize(dresult));
    });
    return thedecimals;
}

async function CalculateBalance() {
    await getMarketData(1);
}

async function calculateDeposit() {
    if(lockthis == 1) {
        return;
    }
    lockthis = 1;
    var section = parseInt(Math.floor(networkvars[0] / networkvars[2]));
    var ak = parseInt(Math.floor(networkvars[0] % networkvars[2]));
    var bayaddy;
    var coin1;
    var exchange;
    var bayselect;
    var thisresult;
    var coin1contract;
    var exchangecontract;
    var paircontract;
    var x;
    var j;
    var token0;
    var reserves;
    var mypair;
    try {
        var el=document.activeElement.id;
        if(el == "CoinPercent") {
            document.getElementById("SwapAmount").value = '';
            document.getElementById("SwapAmount2").value = '';
        }
        if(el == "Coin1amount" || el == "Coin2amount") {
            if(((lastchecked + 120) < (Math.floor(Date.now() / 1000))) && isConnected) {
                showSpinner();
                await getNetworkInfo();
                section = parseInt(Math.floor(networkvars[0] / networkvars[2]));
                ak = parseInt(Math.floor(networkvars[0] % networkvars[2]));
                bayaddy = '';
                coin1 = document.getElementById("Coin1").value;
                currentdecimals = await getDecimals(coin1);
                coin1 = Object.values(pairs[coin1])[0];
                exchange = document.getElementById("exchangeSelect").value;
                exchange = Object.values(exchanges[exchange])[0];
                bayselect = document.getElementById("Coin2").value;
                if(bayselect == 0) {
                    bayaddy = BAYLaddy;
                }
                if(bayselect == 1) {
                    bayaddy = BAYRaddy;
                }
                exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
                mypair = '';
                await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (thisresult) {
                    mypair = DOMPurify.sanitize(thisresult);
                });
                poolreserve = [];
                if(/^0x0+$/.test(mypair) == false) {
                    console.log("Checking pool balance...");
                    await liquiditypool.methods.calculateBalance(myaccounts,mypair,true,0).call().then(function (thisresult) {
                        thisresult = JSON.parse(DOMPurify.sanitize(JSON.stringify(thisresult)));
                        poolreserve[0] = thisresult[0];
                        poolreserve[1] = thisresult[1];
                    })
                    token0 = '';
                    reserves = [];
                    paircontract = new web3.eth.Contract(PairABI, mypair);
                    await paircontract.methods.getReserves().call().then(function (thisresult) {
                        reserves = JSON.parse(DOMPurify.sanitize(JSON.stringify(thisresult)));
                    });
                    await paircontract.methods.token0().call().then(function (thisresult) {
                        token0 = DOMPurify.sanitize(thisresult);
                    });
                    if (token0 === BAYLaddy || token0 === BAYRaddy) {
                        reservebayval = new BN(reserves[0]);
                        reservecoinval = new BN(reserves[1]);
                    } else {
                        reservebayval = new BN(reserves[1]);
                        reservecoinval = new BN(reserves[0]);
                    }

                    if (!reservecoinval.isZero() && !reservebayval.isZero()) {
                        autocompute = 1;
                    }
                }
                lastchecked = (Math.floor(Date.now() / 1000));
            }
        }
        if(el == "SwapAmount" || el == "SwapAmount2") {
            if(((lastchecked2 + 120) < (Math.floor(Date.now() / 1000))) && isConnected) {
                showSpinner();
                console.log("Checking pool reserves...");
                await getNetworkInfo();
                bayaddy = '';
                coin1 = document.getElementById("SwapCoin2").value;
                currentdecimals2 = await getDecimals(coin1);
                coin1 = Object.values(pairs[coin1])[0];
                exchange = document.getElementById("exchangeSelect").value;
                exchange = Object.values(exchanges[exchange])[0];
                bayselect = document.getElementById("SwapCoin").value;
                if(bayselect == 0 || bayselect == 2) {
                    bayaddy = BAYLaddy;
                }
                if(bayselect == 1 || bayselect == 3) {
                    bayaddy = BAYRaddy;
                }
                exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
                mypair = '';
                await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (thisresult) {
                    mypair = DOMPurify.sanitize(thisresult);
                });
                if(/^0x0+$/.test(mypair) == false) {                    
                    token0 = '';
                    reserves = [];
                    paircontract = new web3.eth.Contract(PairABI, mypair);
                    await paircontract.methods.getReserves().call().then(function (thisresult) {
                        reserves = JSON.parse(DOMPurify.sanitize(JSON.stringify(thisresult)));
                    });
                    await paircontract.methods.token0().call().then(function (thisresult) {
                        token0 = DOMPurify.sanitize(thisresult);
                    });
                    if (token0 === BAYLaddy || token0 === BAYRaddy) {
                        reservebayval2 = new BN(reserves[0]);
                        reservecoinval2 = new BN(reserves[1]);
                    } else {
                        reservebayval2 = new BN(reserves[1]);
                        reservecoinval2 = new BN(reserves[0]);
                    }

                    if (reservecoinval2.isZero() && reservebayval2.isZero()) {
                        document.getElementById("SwapSummary").innerHTML =
                            '<div class="callout callout-danger">This pair has not been created yet. To create it please add liquidity or choose the default pair to trade with.</div>';
                        lockthis = 0;
                        hideSpinner();
                        return;
                    }
                } else {
                    document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >This pair has not been created yet. To create it please add liquidity or choose the default pair to trade with.</div>';
                    reservebayval2 = 0;
                    reservecoinval2 = 0;
                    lockthis = 0;
                    hideSpinner();
                    return;
                }
                lastchecked2 = (Math.floor(Date.now() / 1000));
            }
        }
        hideSpinner();
        var myval;
        var mynumerator;
        var text;
        var mtext;
        var textval;
        var name;
        var mytrade;
        var BAYval;
        var CoinVal;
        var recommended;
        var recommended2;
        if(el == "SwapAmount" || el == "SwapAmount2") {            
            if(reservecoinval2.toFixed() !== "0" && reservebayval2.toFixed() !== "0") {
                try {
                  var perc = new BN(document.getElementById('CoinPercent').value);
                  var maxBuy = new BN("0");
                  if(el == "SwapAmount") {
                      myval = new BN(document.getElementById("SwapAmount").value).times(1e8).toFixed(0);
                      maxBuy = new BN(reservebayval2);
                  } else {
                      myval = new BN(document.getElementById("SwapAmount2").value).times(new BN("1e" + currentdecimals2)).toFixed(0);
                      maxBuy = new BN(reservecoinval2);
                  }

                  exchange = document.getElementById("exchangeSelect").value;
                  mynumerator = exchangenum[exchange];
                  text = "";
                  bayselect = document.getElementById("SwapCoin").value;
                  coin1 = document.getElementById("SwapCoin2").value;
                  name = Object.keys(pairs[coin1]);
                  
                  //if (new BN(myval).gt(maxBuy.times(0.99))) {
                  //    document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger">Trade exceeds available pool reserves.</div>';
                      //document.getElementById("SwapAmount").value = "";
                      //document.getElementById("SwapAmount2").value = "";
                      //slippage = 0;
                      //lastSelect = '';
                      //lockthis = 0;
                      //return;
                  //}

                  // Logic for buying/selling coins
                  if(bayselect == 0) {
                      text += "Buying BitBay coins: ";
                      if(el == "SwapAmount") {
                          mtext = "Maximum " + name + " coins: ";
                          lastMinMax = new BN(myval).times(reservecoinval2).div(reservebayval2).times(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          mtext += textval;
                      } else {
                          mtext = "Minimum BitBay coins: ";
                          lastMinMax = new BN(myval).times(reservebayval2).div(reservecoinval2).div(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(1e8).toFixed(8));
                          mtext += textval;
                      }
                  }

                  if(bayselect == 1) {
                      text += "Buying BitBay Reserve coins: ";
                      if(el == "SwapAmount") {
                          mtext = "Maximum " + name + " coins: ";
                          lastMinMax = new BN(myval).times(reservecoinval2).div(reservebayval2).times(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          mtext += textval;
                      } else {
                          mtext = "Minimum BitBay Reserve coins: ";
                          lastMinMax = new BN(myval).times(reservebayval2).div(reservecoinval2).div(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(1e8).toFixed(8));
                          mtext += textval;
                      }
                  }

                  if(bayselect == 2) {
                      text += "Selling BitBay coins: ";
                      if(el == "SwapAmount") {
                          mtext = "Minimum " + name + " coins: ";
                          lastMinMax = new BN(myval).times(reservecoinval2).div(reservebayval2).div(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          mtext += textval;
                      } else {
                          mtext = "Maximum BitBay coins: ";
                          lastMinMax = new BN(myval).times(reservebayval2).div(reservecoinval2).times(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(1e8).toFixed(8));
                          mtext += textval;
                      }
                  }

                  if(bayselect == 3) {
                      text += "Selling BitBay Reserve coins: ";
                      if(el == "SwapAmount") {
                          mtext = "Minimum " + name + " coins: ";
                          lastMinMax = new BN(myval).times(reservecoinval2).div(reservebayval2).div(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          mtext += textval;
                      } else {
                          mtext = "Maximum BitBay Reserve coins: ";
                          lastMinMax = new BN(myval).times(reservebayval2).div(reservecoinval2).times(new BN(1).plus(perc.div(100))).toFixed(0);
                          textval = stripZeros(new BN(lastMinMax).div(1e8).toFixed(8));
                          mtext += textval;
                      }
                  }

                  // Swap amount logic (BN version)
                  if(bayselect == 0 || bayselect == 1) {
                      if(el == "SwapAmount2") {
                          mytrade = new BN(getAmountOut(new BN(myval), reservecoinval2, reservebayval2, mynumerator));
                          BAYval = stripZeros(mytrade.div(1e8).toFixed(8));
                          CoinVal = stripZeros(document.getElementById("SwapAmount2").value);
                          slippage = new BN(myval).div((reservecoinval2.times(mytrade)).div(reservebayval2)).times(100).minus(100);
                          document.getElementById("SwapAmount").value = BAYval;
                      } else {
                          mytrade = new BN(getAmountIn(new BN(myval), reservecoinval2, reservebayval2, mynumerator));
                          BAYval = stripZeros(document.getElementById("SwapAmount").value);
                          CoinVal = stripZeros(mytrade.div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          slippage = mytrade.div((reservecoinval2.times(new BN(myval))).div(reservebayval2)).times(100).minus(100);
                          document.getElementById("SwapAmount2").value = CoinVal;
                      }
                      text += `${BAYval}<br>`;
                      text += `In exchange for ${name} coins: ${CoinVal}`;
                      text += "<hr>";
                  }

                  if(bayselect == 2 || bayselect == 3) {
                      if(el == "SwapAmount2") {
                          mytrade = new BN(getAmountIn(new BN(myval), reservebayval2, reservecoinval2, mynumerator));
                          BAYval = stripZeros(mytrade.div(1e8).toFixed(8));
                          CoinVal = stripZeros(document.getElementById("SwapAmount2").value);
                          slippage = mytrade.div((new BN(myval).div(reservecoinval2.div(reservebayval2)))).times(100).minus(100);
                          document.getElementById("SwapAmount").value = BAYval;
                      } else {
                          mytrade = new BN(getAmountOut(new BN(myval), reservebayval2, reservecoinval2, mynumerator));
                          BAYval = stripZeros(document.getElementById("SwapAmount").value);
                          CoinVal = stripZeros(mytrade.div(new BN("1e" + currentdecimals2)).toFixed(currentdecimals2));
                          slippage = new BN(myval).div((mytrade.div(reservecoinval2.div(reservebayval2)))).times(100).minus(100);
                          document.getElementById("SwapAmount2").value = CoinVal;
                      }
                      text += `${BAYval}<br>`;
                      text += `In exchange for ${name} coins: ${CoinVal}`;
                  }

                  // Slippage and trade details
                  text += `<br>Slippage: ${stripZeros(slippage.toFixed(4))}%<br>This trade is approximate and may vary slightly based on competing trades.`;
                  text += `<br>${mtext}`;

                  if(slippage.gt(perc)) {
                      text += '<hr><div class="callout callout-danger">WARNING: This trade fluctuates more than you have requested</div>';
                      lastSelect = slippage;
                  } else {
                      lastSelect = el;
                  }
                  if (new BN(myval).gt(maxBuy.times(0.99))) {
                       text += '<hr><div class="callout callout-danger">Trade exceeds available pool reserves.</div>';
                  }
                  document.getElementById("SwapSummary").innerHTML = text;
                } catch (e) {
                    slippage = 0;
                    lastSelect = '';
                    console.log(e);
                }
            }
            lockthis = 0;
            hideSpinner();
            return;
        } else {
          document.getElementById("additionalCoins").innerHTML = "";

          if (el === "Coin1amount" && autocompute === 1) {
              try {
                  const coin1Input = new BN(document.getElementById("Coin1amount").value.trim());
                  const myval = coin1Input.times(new BN(10).pow(new BN(currentdecimals))); // scale by 1e<currentdecimals>
                  
                  // Calculate recommended Coin2 amount using BigNumber arithmetic
                  const recommended = myval
                      .times(new BN(reservebayval.toString()))
                      .div(new BN(reservecoinval.toString()))
                      .div(new BN("100000000")); // Convert back to human-readable format (div by 1e8)
                  document.getElementById("Coin2amount").value = stripZeros(recommended.toFixed(8));
              } catch (e) {
                  console.log(e);
                  recommendedBAY = 0;
                  lockthis = 0;
                  hideSpinner();
                  return;
              }
          }

          if (el === "Coin2amount" && autocompute === 1) {
              try {
                  const coin2Input = new BN(document.getElementById("Coin2amount").value.trim());
                  const myval = coin2Input.times(new BN("100000000")); // scale by 1e8

                  // Calculate recommended Coin1 amount using BigNumber arithmetic
                  const recommended = myval
                      .times(new BN(reservecoinval.toString()))
                      .div(new BN(reservebayval.toString()))
                      .div(new BN(10).pow(new BN(currentdecimals))); // Scale back to Coin1 decimals
                  document.getElementById("Coin1amount").value = stripZeros(recommended.toFixed(currentdecimals));
              } catch (e) {
                  console.log(e);
                  recommendedBAY = 0;
                  lockthis = 0;
                  hideSpinner();
                  return;
              }
          }

          // Parse Coin2 amount into BN, scaled by 1e8
          const myBAYval = new BN(document.getElementById("Coin2amount").value.trim()).times(new BN("100000000"));

          let ratioBAY = new BN(0);
          let ratioBAYR = new BN(0);
          let ratioBAY2 = new BN(0);
          let ratioBAYR2 = new BN(0);
          let thedif;
          let x = 0;

          if (autocompute === 0) {
              while (x < networkvars[1]) {
                  if (x === section) {
                      thedif = new BN(0);
                      if (ak !== 0) {
                          thedif = new BN(fairRatio[x].toString())
                              .times(new BN(ak.toString()))
                              .div(new BN(networkvars[2].toString()));
                          ratioBAYR = ratioBAYR.plus(thedif);
                      }
                      ratioBAY = ratioBAY.plus(new BN(fairRatio[x].toString()).minus(thedif));
                  } else {
                      if (x > section) {
                          ratioBAY = ratioBAY.plus(new BN(fairRatio[x].toString()));
                      }
                      if (x < section) {
                          ratioBAYR = ratioBAYR.plus(new BN(fairRatio[x].toString()));
                      }
                  }
                  x += 1;
              }
          } else {
              ratioBAY2 = new BN(poolreserve[0].toString());
              ratioBAYR2 = new BN(poolreserve[1].toString());
          }

          // Handle the selection of the bayselect value
          const bayselect = document.getElementById("Coin2").value;
          let recommended;

          if (bayselect === "0") {
              document.getElementById("additionalCoins").innerHTML = "Reserve required for deposit (in addition to desired liquid coins):<br>";
              recommended = myBAYval
                  .times(ratioBAYR)
                  .div(ratioBAY)
                  .div(new BN("100000000")); // Convert back to human-readable format (div by 1e8)

              if (autocompute === 1) {
                  recommended = myBAYval
                      .times(ratioBAYR2)
                      .div(ratioBAY2)
                      .div(new BN("100000000")); // Convert back to human-readable format (div by 1e8)
              }
              document.getElementById("additionalCoins").innerHTML += stripZeros(recommended.toFixed(8));
              recommendedBAY = stripZeros(recommended.toFixed(8));
          } else {
              document.getElementById("additionalCoins").innerHTML = "Liquid required for deposit (in addition to desired reserve coins):<br>";
              recommended = myBAYval
                  .times(ratioBAY)
                  .div(ratioBAYR)
                  .div(new BN("100000000")); // Convert back to human-readable format (div by 1e8)

              if (autocompute === 1) {
                  recommended = myBAYval
                      .times(ratioBAY2)
                      .div(ratioBAYR2)
                      .div(new BN("100000000")); // Convert back to human-readable format (div by 1e8)
              }
              document.getElementById("additionalCoins").innerHTML += stripZeros(recommended.toFixed(8));
              recommendedBAY = stripZeros(recommended.toFixed(8));
          }
        }
    } catch (e) {
        hideSpinner();
        recommendedBAY = 0;
        console.log(e);
    }
    lockthis = 0;
}

function getAmountOut(amountIn, reserveIn, reserveOut, mynumerator) {
    const amountInWithFee = amountIn.times(mynumerator); //Uniswap is 997, Pancakeswap is 998
    const numerator = amountInWithFee.times(reserveOut);
    const denominator = reserveIn.times(new BN(1000)).plus(amountInWithFee);
    const amountOut = numerator.div(denominator);
    // Check slippage: amountOut / reserveOut > 0.995
    const slippageRatio = amountOut.div(reserveOut);
    if (slippageRatio.gt(new BN("0.995"))) {
        return new BN(0); // Slippage is too high
    }
    return amountOut;
}

function getAmountIn(amountOut, reserveIn, reserveOut, mynumerator) {
    if (amountOut.gt(reserveOut)) {
        amountOut = reserveOut;
    }

    const numerator = reserveIn.times(amountOut).times(new BN(1000));
    const denominator = reserveOut.minus(amountOut).times(mynumerator);
    const amountIn = numerator.div(denominator).plus(new BN(1)); // Round up

    return amountIn;
}

function makeFairRatio() {
    var x = 0;
    var j = 0;
    var tot = 0;
    var newtot = 1000000000;
    fairRatio = [];    
    while(x < (networkvars[1])) {
        j = 0;
        tot = 0;
        while(j < networkvars[2]) {
            liquid = parseInt(newtot - (newtot * (networkvars[4] ** (100 - networkvars[3]))) / (100 **  (100 - networkvars[3])));
            newtot -= liquid;
            tot += liquid;
            j += 1;
        }
        fairRatio.push(tot)
        x += 1;
    }
    fairRatio[networkvars[1] - 1] += newtot;
}

function calculateSupply(mysupply, mydefrate, mypegrate) {
    var perc = 100;
    var x = 0;
    while(x < mysupply) {
        perc = perc * ((mydefrate ** (100 - mypegrate)) / (100 **  (100 - mypegrate)));
        x += 1;
    }
    return parseFloat(perc).toFixed(8);
}

async function showFrozen() {
    var result = [];
    var result2 = [];
    showSpinner();
    try {
      await baydatacontract.methods.getFrozen(myaccounts).call().then(function (myresult) {
          result = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresult)));
      })
      var result2 = networkvars;
      var x = 0;
      var y = 0;    
      var ftext = "";
      var val2;
      var amt;
      var myblock = JSON.parse(DOMPurify.sanitize(JSON.stringify(await web3.eth.getBlock(await web3.eth.getBlockNumber()))));
      var release;
      while(x < 4) {
          val2 = 0;
          await baydatacontract.methods.FrozenTXDBTimeSpent(myaccounts,x,0).call().then(function (newval) {
              val2 = parseInt(DOMPurify.sanitize(newval));
          });
          if(val2 == 1) {
              await baydatacontract.methods.FrozenTXDBTimeSpent(myaccounts,x,1).call().then(function (newval) {
                  newval = DOMPurify.sanitize(newval);
                  y = 0;
                  amt = new BN(0);
                  //If you want you can calculate both liquid and reserve for each payment if you follow the release frozen calculation protocol
                  while(y < result2[1]) {
                      amt = amt.plus(new BN(result[x][y]));
                      y += 1;
                  }
                  if(myblock.timestamp > parseInt(newval) + reservetimelock) {
                      release = "(currently available)";
                  } else {
                      release = "(available in " + parseFloat(((((parseInt(newval) + reservetimelock) - parseInt(myblock.timestamp)) / 60) / 60).toFixed(2)) + " hours)";
                  }
                  ftext += "Amount: " + stripZeros(amt.dividedBy(1e8).toFixed(8)) + "<br>" + "Timestamp to release funds: " + newval + release + "<br>";
              });
          }
          x += 1;
      }
      hideSpinner();
      if(ftext == "") {
          ftext = "You currently have no frozen coins."
          modalDialog('Frozen Coins', DOMPurify.sanitize(ftext));
          return false;
      }            
      modalDialog('Frozen Coins', DOMPurify.sanitize(ftext));      
    } catch (e) {
      console.log(e);
      hideSpinner();
    }
    return true;
}

async function sendFrozen() {
    if (await showFrozen()) {
      if(lastrun > (Math.floor(Date.now() / 1000))) {
            return;
        }
        lastrun = (Math.floor(Date.now() / 1000)) + 7;
        Swal.fire({
            icon: 'info',
            title: 'Frozen coins',
            text: 'Attempting to Release frozen coins. Please approve the transaction...',
            confirmButtonText: 'Close'
        });
        baydatacontract.methods.ReleaseFrozenFunds(myaccounts).send({"from":myaccounts,"gasLimit": 2500000,"gasPrice": gasPrice});
        checkbalances();
    }else {      
    }
}

async function showPegChart(selectedChart = 0) {
    var result = [];
    var result2 = [];
    if(selectedChart == 9) {
        if(document.getElementById("ChartSelect").value == 0) {
            selectedChart = 1;
        } else {
            selectedChart = 2;
        }
    }
    if(selectedChart != prevselect) {
        prevselect = selectedChart;
        prevtime = 0;
    }
    if(prevtime + 120 < (Math.floor(Date.now() / 1000))) {        
        if(selectedChart == 0) {
            await baydatacontract.methods.calculateBalance(myaccounts,0).call().then(function (myresult4) {
                result = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresult4[2])));
                console.log(result)
            })
        }
        if(selectedChart == 1) {
            await liquiditypool.methods.calculateBalance(myaccounts, mycurrentpair, true, 0).call().then(function (myresult4) {
                result = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresult4[2])));
            })
        }
        if(selectedChart == 2) {
            await liquiditypool.methods.calculatePoolBalanceV1(myaccounts, mycurrentpair, 0, LPtokens, precision, 0).call().then(function (myresult4) {
                result = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresult4[1])));
            })
        }
        prevresult = result;
        prevtime = (Math.floor(Date.now() / 1000));
    } else {
        result = prevresult;
    }
    result2 = networkvars;
    var x = 0;
    var y = 0;
    var data = [];
    var section = Math.floor(result2[0] / result2[2]);
    var ak = Math.floor(result2[0] % result2[2]);
    var highkey = 0;
    var labels = [];
    var iters = 0;
    var iters2 = 0;
    var min = 0;
    var max = parseInt(result2[1] * result2[2]);
    if(selectedChart == 0) {
        if(document.getElementById("range1").value == "") {
            document.getElementById("range1").value = min;
        } else {
            if(parseInt(document.getElementById("range1").value) > 0) {
                min = parseInt(document.getElementById("range1").value);
            }
        }
        if(document.getElementById("range2").value == "") {
            document.getElementById("range2").value = max;

        } else {
            if(parseInt(document.getElementById("range2").value) < max) {
                max = parseInt(document.getElementById("range2").value);
            }
        }
    } else {
        if(document.getElementById("range3").value == "") {
            document.getElementById("range3").value = min;
        } else {
            if(parseInt(document.getElementById("range3").value) > 0) {
                min = parseInt(document.getElementById("range3").value);
            }
        }
        if(document.getElementById("range4").value == "") {
            document.getElementById("range4").value = max;

        } else {
            if(parseInt(document.getElementById("range4").value) < max) {
                max = parseInt(document.getElementById("range4").value);
            }
        }
    }
    if (min >= max) {
        return;
    }
    var tot;
    var tot2;
    while(x < result2[1]) {        
        let y = 0;
        let tot = new BigNumber(result[x]).dividedToIntegerBy(new BigNumber(result2[2]));
        let tot2 = new BigNumber(result[x]);

        while (y < result2[2]) {
            if (x == section) {
                if (y == ak) {
                    highkey = iters2;
                }
                if (iters >= min && iters <= max) {
                    const val = new BigNumber(result[parseInt(result2[1]) + y]);
                    data.push(val.toString());
                    iters2 += 1;
                }
            } else {
                if (y == result2[2] - 1) {
                    if (tot2.isNegative()) {
                        tot2 = new BigNumber(0);
                    }
                    if (iters >= min && iters <= max) {
                        data.push(tot2.toString());
                        iters2 += 1;
                    }
                } else {
                    tot2 = tot2.minus(tot);
                    if (tot.isNegative()) {
                        tot = new BigNumber(0);
                    }
                    if (iters >= min && iters <= max) {
                        data.push(tot.toString());
                        iters2 += 1;
                    }
                }
            }
            iters += 1;
            y += 1;
        }
        if(iters >= min && iters <= max) {
            labels.push(x);
        }
        x += 1;
    }
    //console.log(JSON.stringify(data))
    paintchart(labels,data,highkey,selectedChart);

    if(selectedChart == 0) {
      document.getElementById('chartContainerInputs').classList.remove('hidden');
      document.getElementById('chartContainer').classList.remove('hidden');
    }else {
      document.getElementById('chartContainer2Inputs').classList.remove('hidden');
      document.getElementById('chartContainer2').classList.remove('hidden');
    }

}

function paintchart(mylabels, mydata, thehighkey, selectedChart) {
    //console.log(mydata.length)
    var chartstring;
    if(selectedChart == 0) {
        chartstring = '#chartContainer'
    } else {
        chartstring = '#chartContainer2'
    }
    chart = new Chartist.Bar(chartstring, {
      labels: mylabels,
      series: [
        mydata.map(s => ({ value: parseInt(s, 10), meta: s }))
      ]
    }, {
      low: 0,
      showArea: true,
      seriesBarDistance: 50,
      axisX: {
        showLabel: false },
      axisY: {
        labelInterpolationFnc: function(value, index) {
          return index % 0 === 0 ? value : null;
        }
      },
      plugins: [
        Chartist.plugins.tooltip()
      ]
    });

    chart.on('draw', function(context) {
        if(context.type === 'bar' && context.index >= thehighkey) {
            context.element.attr({
              style: 'stroke: hsla(200, 100%, 50%, 0.5); stroke-width: 4px;'
            });
            return;

        }
        if(context.type === 'bar' && context.index < thehighkey) {
            context.element.attr({
              style: 'stroke: hsla(255, 100%, 50%, 0.5); stroke-width: 4px;'
            });

        }
    });
}
jsondata={}
async function mintFromBitBay(jsondata) {
    jsondata = JSON.parse(jsondata.toString().replace(/'/g,'"').replace(/\n/g,'').replace(/\r/g,'').trim());
    bayadmincontract.methods.redeemTX(jsondata['root'],jsondata['proof'],jsondata['reserve'],jsondata['txid']).send({"from":myaccounts,"gasLimit": 2500000,"gasPrice": gasPrice});
}

async function registerBitBay(regaddy) {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    //if(regaddy[0] != 'b' && regaddy[0] != "B") {
        //document.getElementById("text1").innerHTML += "<br><br>Invalid BitBay address.";
    //    modalDialog('Connect', "Invalid BitBay address.", "danger");
    //    return;
    //}
    if(coinjs.addressDecode(regaddy) == false) {
        //document.getElementById("text1").innerHTML += "<br><br>Invalid BitBay address.";
        Swal.fire({
            icon: 'warning',
            title: 'Invalid BitBay address',
            confirmButtonText: 'Close'
        });
        modalDialog('Connect', "Invalid BitBay address.", "danger");
        return;
    }
    var found = 1;
    var selectedaccount = myaccounts;
    await bayadmincontract.methods.BAYaddress(selectedaccount).call().then(function (myresult5) {
        if(DOMPurify.sanitize(myresult5) == regaddy){
            found = 0;
            //document.getElementById("text1").innerHTML += "<br><br>A BitBay address is already registered to your address.";
            Swal.fire({
                icon: 'warning',
                title: 'A BitBay address is already registered to your address.',
                confirmButtonText: 'Close'
            });
            modalDialog('Connect', "A BitBay address is already registered to your address.", "danger");
            return;
        }    
    });
    if(found == 0) {
        return;
    }
    bayadmincontract.methods.register(regaddy).send({"from":selectedaccount,"gasLimit": 500000,"gasPrice": gasPrice});
}

async function burnToBitBay(burnamount) {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    if(await web3.eth.net.getId() != currentChainId) {
        //document.getElementById("text1").innerHTML += "<br><br>The selected chain was recently changed or you are not logged in, please log in again.";
        Swal.fire({
            icon: 'warning',
            title: 'The selected chain was recently changed or you are not logged in, please log in again.',
            confirmButtonText: 'Close'
        });
        modalDialog('Connect', "The selected chain was recently changed or you are not logged in, please log in again.", "danger");
        return;
    }
    burnamount = new BN(web3.utils.toWei(burnamount, 'gwei')).div(10).toString();
    var myvar = document.getElementById("coinToBurn").value;
    var selectedaccount = myaccounts;
    var myadmin = "";
    await baydatacontract.methods.minter().call().then(function (dataadmin) {
        myadmin = DOMPurify.sanitize(dataadmin);
    })    
    var found = 1;
    await bayadmincontract.methods.BAYaddress(selectedaccount).call().then(function (results) {
        results = DOMPurify.sanitize(results);
        if(!results && results.length == 0){
            //document.getElementById("text1").innerHTML += "<br><br>You need to register your BitBay address before burning.";
            Swal.fire({
                icon: 'warning',
                title: 'You need to register your BitBay address before burning.',
                confirmButtonText: 'Close'
            });
            modalDialog('Connect', "You need to register your BitBay address before burning.", "danger");
            found = 0;
        }
    });
    if(found == 0) {
        return;
    }
    if(BAYAdmin != myadmin) {
        //document.getElementById("text1").innerHTML += "<br><br>Burn address does not match known admin contract.";
        Swal.fire({
            icon: 'warning',
            title: 'Burn address does not match known admin contract.',
            confirmButtonText: 'Close'
        });
        modalDialog('Connect', "Burn address does not match known admin contract.", "danger");
        return;
    }
    console.log(burnamount);
    if(myvar == "Reserve Coins") {
        bayrcontract.methods.transfer(myadmin, burnamount).send({"from":selectedaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
    }
    if(myvar == "Liquid Coins") {
        baylcontract.methods.transfer(myadmin, burnamount).send({"from":selectedaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
    }
}

jsonreceipt = {};
async function showNonces() {
    document.getElementById("merkletext").classList.remove("hidden");
    document.getElementById("merkletext").innerHTML = "Loading...";
    var item = '';
    var returnthis = 0;
    var currentaccount = myaccounts;
    await bayadmincontract.methods.listNonces(currentaccount).call().then(function (myresults) {
        myresults = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresults)));
        if(myresults.length == 0) {
            document.getElementById("merkletext").innerHTML = 'No history of burned funds to BitBay network from this account.';
            returnthis = 1;
            return;
        }
        if(lastitem == 10000000) {
            lastitem = myresults.length - 1;
        } else {
            if(lastitem != 0) {
                lastitem -= 1;
            } else {
                lastitem = myresults.length - 1;
            }
        }
        item = myresults[lastitem];
    });
    if (returnthis == 1) {
        return;
    }
    var intervaltime = 0;
    var processingTime = 0;

    jsonreceipt = {'nonce':item,'from':currentaccount};
    await bayadmincontract.methods.recipient(item, currentaccount).call().then(function (myresults) {
        jsonreceipt['address'] = DOMPurify.sanitize(myresults);
    });
    await bayadmincontract.methods.showReserve(currentaccount, item).call().then(function (myresults) {
        jsonreceipt['reserve'] = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresults)));
    });
    await bayadmincontract.methods.highkey(item, currentaccount).call().then(function (myresults) {
        jsonreceipt['section'] = DOMPurify.sanitize(myresults);
    });
    await bayadmincontract.methods.intervaltime().call().then(function (myresults) {
        intervaltime = DOMPurify.sanitize(myresults);
    });
    await bayadmincontract.methods.processingTime(item).call().then(function (myresults) {
        processingTime = DOMPurify.sanitize(myresults);
    });
    var steps = parseInt(networkvars[1]) + parseInt(networkvars[2]);
    var myhash = web3.utils.keccak256(web3.eth.abi.encodeParameters(['string','uint256[' + steps.toString() + ']','uint256','uint256','address'],[jsonreceipt['address'],jsonreceipt['reserve'],jsonreceipt['section'],jsonreceipt['nonce'],currentaccount]));
    var x = 0;
    var amt = new BN(0);
    while(x < steps) {
        amt=amt.plus(new BN(jsonreceipt['reserve'][x]));
        x += 1;
    }
    amt = stripZeros(amt.dividedBy(1e8).toFixed(8));
    document.getElementById("merkletext").innerHTML = DOMPurify.sanitize("Nonce: " + item + "<br>Hash: " + myhash + "<br>Total coins: " + amt);
    var block = JSON.parse(DOMPurify.sanitize(JSON.stringify(await web3.eth.getBlock(await web3.eth.getBlockNumber()))));;
    if ((parseInt(processingTime) + parseInt(intervaltime) + parseInt(intervaltime)) < parseInt(block.timestamp)) {
        document.getElementById("merkletext").innerHTML += "<br>Merkle Proof: Merkle tree ready, you may copy the receipt to the clipboard.";
        var leaves = [];
        await bayadmincontract.methods.listHashes(item).call().then(function (myresults) {
            leaves = JSON.parse(DOMPurify.sanitize(JSON.stringify(myresults)));
        });
        var tree = new MerkleTree(leaves, web3.utils.keccak256, { sort: true });
        var root = tree.getRoot().toString('hex');
        var leaf = myhash;
        //proof = tree.getProof(leaf);
        //console.log(tree.verify(proof, leaf, root)) // true
        //console.log(tree)
        //console.log(leaves)
        //console.log(tree.toString())
        jsonreceipt['proof'] = tree.getHexProof(leaf);
        jsonreceipt['root'] = tree.getHexRoot();
    } else {
        document.getElementById("merkletext").innerHTML += "<br>Merkle Proof: This tree is not processed yet. Please check again later.";
        jsonreceipt = {}
    }
}

async function copyNonce() {
    if(JSON.stringify(jsonreceipt) == "{}") {
        document.getElementById("merkletext").innerHTML = "Current receipt is empty or not processed yet.";
        return
    } else {
        navigator.clipboard.writeText(JSON.stringify(jsonreceipt));
    }
}

async function addLiquidity() {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    //make sure to secure the variables
    var coin1val = document.getElementById('Coin1amount').value;
    var coin2val = document.getElementById('Coin2amount').value;
    var perc = parseFloat(document.getElementById('CoinPercent').value);
    var mydecimals = '';
    var otherval;
    var amount1min;
    var amount2min;
    var totalval;
    var recommended = recommendedBAY;
    var currentaccount = myaccounts;
    var coin1 = document.getElementById("Coin1").value;
    var weth = false;
    if(coin1 == 0) {
        weth = true;
    }
    var exchange = document.getElementById("exchangeSelect").value;
    var mycoin1 = coin1;
    coin1 = Object.values(pairs[coin1])[0];    
    exchange = Object.values(exchanges[exchange])[0];
    var myrouter = Object.values(routers[0])[0];
    var coin1contract = new web3.eth.Contract(ERC20ABI, coin1);
    var routercontract = new web3.eth.Contract(RouterABI, myrouter);
    var exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
    var bayselect = document.getElementById("Coin2").value;
    var bayaddy = '';
    var allowance = 0;
    var mypair = '';
    var myhighkey = 0;
    var section = 0;
    if(bayselect == 0) {
        bayaddy = BAYLaddy;
    }
    if(bayselect == 1) {
        bayaddy = BAYRaddy;
    }
    await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (liqresult) {
        mypair = DOMPurify.sanitize(liqresult);
    });
    try {
      try {
          showSpinner();
          await coin1contract.methods.allowance(currentaccount, myrouter).call().then(function (liqresult) {
              allowance = DOMPurify.sanitize(liqresult);
          });
          if(parseInt(allowance) == 0) {
              //document.getElementById("addliquidtext").innerHTML = 'Waiting for router allowance authorization on the blockchain for the first coin...';
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for the first coin...',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Waiting for router allowance authorization on the blockchain for the first coin...", "warning");
              await coin1contract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":currentaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
          allowance = 0;
          await baydatacontract.methods.allowance(currentaccount, myrouter).call().then(function (liqresult) {
              allowance = DOMPurify.sanitize(liqresult);
          });
          if(parseInt(allowance) == 0) {
              //document.getElementById("addliquidtext").innerHTML = 'Waiting for router allowance authorization on the blockchain for BAY...';
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for BAY...',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Waiting for router allowance authorization on the blockchain for BAY...", "warning");
              await baylcontract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":currentaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
          allowance = 0;
          await baydatacontract.methods.allowanceReserve(currentaccount, myrouter).call().then(function (liqresult) {
              allowance = DOMPurify.sanitize(liqresult);
          });
          if(parseInt(allowance) == 0) {
              //document.getElementById("addliquidtext").innerHTML = 'Waiting for router allowance authorization on the blockchain for BAYR...';
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for BAYR...',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Waiting for router allowance authorization on the blockchain for BAYR...", "warning");
              await bayrcontract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":currentaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
      } catch (e) {
          console.log(e);
          //document.getElementById("addliquidtext").innerHTML = 'Approval failed';
          Swal.fire({
              icon: 'error',
              text: 'Approval failed',
              confirmButtonText: 'Close'
          });
          modalDialog('Connect', "Approval failed", "danger");
          hideSpinner();
          return;
      }
      if(/^0x0+$/.test(mypair) == false) {
          await liquiditypool.methods.poolhighkey(mypair).call().then(function (liqresult) {
              myhighkey = parseInt(DOMPurify.sanitize(liqresult));
          });
          section = Math.floor(networkvars[0] / networkvars[2]);
          if(myhighkey != section) {
              //document.getElementById("addliquidtext").innerHTML = 'Syncing AMM...';
              Swal.fire({
                  icon: 'info',
                  title: 'Syncing pair',
                  text: 'Authorizing Metamask to Sync AMM for this pair...',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Syncing AMM...", "warning");
              try {
                  await liquiditypool.methods.syncAMM(mypair).send({"from":currentaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
              } catch (e) {
                  console.log(e);
                  //document.getElementById("addliquidtext").innerHTML = 'Syncing failed';
                  Swal.fire({
                      icon: 'error',
                      text: 'Syncing failed',
                      confirmButtonText: 'Close'
                  });
                  modalDialog('Connect', "Syncing failed", "danger");
                  hideSpinner();
                  return;
              }
              document.getElementById("Coin1amount").value = '';
              document.getElementById("Coin2amount").value = '';
              lastchecked = 0;
              lastchecked2 = 0;
          }
      }
      if(myhighkey != section) {
          //document.getElementById("addliquidtext").innerHTML = 'This pair is now in sync. Please recalculate your deposit.';
          Swal.fire({
              icon: 'info',
              title: 'Pair in sync',
              text: 'This pair is now in sync. Please recalculate your deposit.',
              confirmButtonText: 'Close'
          });
          modalDialog('Connect', "This pair is now in sync. Please recalculate your deposit.", "success");
          hideSpinner();
          return;
      }
      //document.getElementById("addliquidtext").innerHTML = '';
      if(parseFloat(coin1val) == 0) {
          //document.getElementById("addliquidtext").innerHTML = 'Amount can not be zero';
          Swal.fire({
              icon: 'warning',
              text: 'Amount can not be zero',
              confirmButtonText: 'Close'
          });
          modalDialog('Connect', "Amount can not be zero", "warning");
          hideSpinner();
          return;
      }
      if(parseFloat(coin2val) == 0) {
          //document.getElementById("addliquidtext").innerHTML = 'Amount can not be zero';
          Swal.fire({
              icon: 'warning',
              text: 'Amount can not be zero',
              confirmButtonText: 'Close'
          });
          modalDialog('Connect', "Amount can not be zero", "warning");
          hideSpinner();
          return;
      }
      if(perc == 0 || perc > 1000) {
          //document.getElementById("addliquidtext").innerHTML = 'Percentage incorrect, usually 1-5% is recommended';
          Swal.fire({
              icon: 'warning',
              text: 'Percentage incorrect, usually 1-5% is recommended',
              confirmButtonText: 'Close'
          });
          modalDialog('Connect', "Percentage incorrect, usually 1-5% is recommended", "danger");
          hideSpinner();
          return;
      }
      mydecimals = await getDecimals(mycoin1);
      mydecimals = new BN("1e" + mydecimals);

      // Using BigNumber for calculations
      coin1val = new BN(coin1val).times(mydecimals).toFixed(0);
      coin2val = new BN(web3.utils.toWei(coin2val, 'gwei')).div(10).toFixed(0);
      otherval = new BN(0);
      amount1min = new BN(coin1val).times(100 - perc).div(100).toFixed(0);

      if (bayselect == 0) {
          otherval = new BN(coin2val);
          recommended = new BN(recommended).times(1e8).toFixed(0);
          totalval = new BN(recommended).plus(otherval).toFixed(0);
          amount2min = new BN(10000).times(perc).div(100).toFixed(0);
      } else {
          otherval = new BN(recommended).times(1e8);
          totalval = new BN(coin2val).plus(otherval).toFixed(0);
          amount2min = new BN(10000).times(perc).div(100).toFixed(0);
      }

      let returnthis = 0;
      await baylcontract.methods.balanceOf(currentaccount).call().then(function (myliquid) {
          if (otherval.gt(new BN(DOMPurify.sanitize(myliquid)))) {
              //document.getElementById("addliquidtext").innerHTML = 'Not enough liquid funds for deposit';
              Swal.fire({
                  icon: 'warning',
                  text: 'Not enough liquid funds for deposit',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Not enough liquid funds for deposit", "danger");
              returnthis = 1;
          }
      });
      await bayrcontract.methods.balanceOf(currentaccount).call().then(function (myrval) {
          if (new BN(totalval).minus(otherval).gt(new BN(DOMPurify.sanitize(myrval)))) {
              //document.getElementById("addliquidtext").innerHTML = 'Not enough reserve funds for deposit';
              Swal.fire({
                  icon: 'warning',
                  text: 'Not enough reserve funds for deposit',
                  confirmButtonText: 'Close'
              });
              modalDialog('Connect', "Not enough reserve funds for deposit", "danger");
              returnthis = 1;
          }
      });
      if(weth) {
          await window.web3.eth.getBalance(myaccounts, function(myliquid) {
              if (new BigNumber(coin1val).gt(new BigNumber(DOMPurify.sanitize(myliquid)))) {
                  //document.getElementById("addliquidtext").innerHTML = 'Not enough coins for deposit';
                  Swal.fire({
                      icon: 'warning',
                      text: 'Not enough coins for deposit',
                      confirmButtonText: 'Close'
                  });
                  modalDialog('Connect', "Not enough coins for deposit", "danger");
                  returnthis = 1;
              }
          });
      } else {
          await coin1contract.methods.balanceOf(currentaccount).call().then(function (myliquid) {
              if (new BigNumber(coin1val).gt(new BigNumber(DOMPurify.sanitize(myliquid)))) {
                  //document.getElementById("addliquidtext").innerHTML = 'Not enough coins for deposit';
                  Swal.fire({
                      icon: 'warning',
                      text: 'Not enough coins for deposit',
                      confirmButtonText: 'Close'
                  });
                  modalDialog('Connect', "Not enough coins for deposit", "danger");
                  returnthis = 1;
              }
          });
      }
      if(returnthis == 1) {
          hideSpinner();
          return;
      }
      var block = JSON.parse(DOMPurify.sanitize(JSON.stringify(await web3.eth.getBlock(await web3.eth.getBlockNumber()))));;
      var deadline = (block.timestamp + 1200).toString();
      coin1val = coin1val.toString();
      totalval = totalval.toString();
      otherval = otherval.toString();
      amount2min = amount2min.toString();
      amount1min = amount1min.toString();
      console.log(coin1val)
      console.log(totalval)
      console.log(otherval)
      console.log(amount2min)
      console.log(amount1min)
      //document.getElementById("addliquidtext").innerHTML = 'Attempting to add liquidity, please approve the transaction...';
      Swal.fire({
          icon: 'info',
          title: 'Adding liquidity',
          text: 'Attempting to add liquidity, please approve the transaction...',
          confirmButtonText: 'Close'
      });
      modalDialog('Connect', "Attempting to add liquidity, please approve the transaction...", "warning");
      try {
          if(weth) {
              await routercontract.methods.addLiquidityETH(bayaddy,totalval,otherval,amount2min,amount1min,currentaccount,deadline,exchange).send({"from":currentaccount,"value":coin1val,"gasLimit": 9000000,"gasPrice": gasPrice});
          } else {
              await routercontract.methods.addLiquidity([bayaddy,coin1],[totalval,coin1val],otherval,amount2min,amount1min,currentaccount,deadline,exchange).send({"from":currentaccount,"gasLimit": 9000000,"gasPrice": gasPrice});
          }
      } catch (e) {
          console.log(e);
          //document.getElementById("addliquidtext").innerHTML = 'Transaction failed';
          modalDialog('Connect', "Transaction failed", "danger");        
          Swal.fire({
              icon: 'error',
              text: 'Transaction failed: ' + e.message,
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      //document.getElementById("addliquidtext").innerHTML = 'Success!';
      modalDialog('Connect', "Success", "success");
      document.getElementById("Coin1amount").value = '';
      document.getElementById("Coin2amount").value = '';
      checkbalances();
      Swal.fire({
          icon: 'success',
          title: 'Deposit Successful',
          confirmButtonText: 'Close'
      });
      hideSpinner();
    } catch (e) {
      console.log(e);
      hideSpinner();
    }
}

async function Swap() {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    if(lastSelect == '') {
        document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >Error</div>';
        return;       
    }
    if(lastSelect != 'SwapAmount' && lastSelect != 'SwapAmount2') {
        Swal.fire({
            icon: 'warning',
            title: 'Price Slippage Warning',
            text: 'You will have to increase the min/max price fluctuation to higher than ' + stripZeros(slippage.toFixed(4)) + ' to complete this trade.',
            confirmButtonText: 'Close'
        });
        document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >You will have to increase the min/max price fluctuation to higher than ' + stripZeros(slippage.toFixed(4)) + ' to complete this trade.</div>';
        document.getElementById("SwapAmount").value = '';
        document.getElementById("SwapAmount2").value = '';
        return;
    }
    var swapval = document.getElementById("SwapAmount").value;
    var org1 = swapval;
    var org2 = document.getElementById("SwapAmount2").value;
    if(lastSelect == "SwapAmount2") {
        swapval = document.getElementById("SwapAmount2").value;    
    }
    var lastMinMax2 = lastMinMax;
    var perc = parseFloat(document.getElementById('CoinPercent').value);
    var chosenaccount = myaccounts;
    var prevtext = document.getElementById("SwapSummary").innerHTML;
    var coin1 = document.getElementById("SwapCoin2").value;
    var weth = false;
    if(coin1 == 0) {
        weth = true;
    }
    var mycoin1 = coin1;
    coin1 = Object.values(pairs[coin1])[0];
    var exchange = document.getElementById("exchangeSelect").value;
    exchange = Object.values(exchanges[exchange])[0];
    var myrouter = Object.values(routers[0])[0];
    var coin1contract = new web3.eth.Contract(ERC20ABI, coin1);
    var routercontract = new web3.eth.Contract(RouterABI, myrouter);
    var exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
    var bayselect = document.getElementById("SwapCoin").value;
    var bayaddy = '';
    var allowance = 0;
    var mypair = '';
    var myhighkey = 0;
    var section = 0;
    var decimals = '';
    var returnthis = 0;
    if(bayselect == 0 || bayselect == 2) {
        bayaddy = BAYLaddy;
    }
    if(bayselect == 1 || bayselect == 3) {
        bayaddy = BAYRaddy;
    }
    await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (swapresult) {
        mypair = DOMPurify.sanitize(swapresult);
    });
    decimals = await getDecimals(mycoin1);
    decimals = "1e" + decimals;
    try {
      try {
          showSpinner();
          await coin1contract.methods.allowance(chosenaccount, myrouter).call().then(function (swapresult) {
              allowance = DOMPurify.sanitize(swapresult);
          });
          if(parseInt(allowance) == 0) {
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for first coin...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Waiting for router allowance authorization on the blockchain for the first coin...</div><br>' + prevtext;
              await coin1contract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":chosenaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
          allowance = 0;
          await baydatacontract.methods.allowance(chosenaccount, myrouter).call().then(function (swapresult) {
              allowance = DOMPurify.sanitize(swapresult);
          });
          if(parseInt(allowance) == 0) {
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for BAY...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Waiting for router allowance authorization on the blockchain for BAY...</div><br>' + prevtext;
              await baylcontract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":chosenaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
          allowance = 0;
          await baydatacontract.methods.allowanceReserve(chosenaccount, myrouter).call().then(function (swapresult) {
              allowance = DOMPurify.sanitize(swapresult);
          });
          if(parseInt(allowance) == 0) {
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for BAYR...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Waiting for router allowance authorization on the blockchain for BAYR...</div><br>' + prevtext;
              await bayrcontract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":chosenaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
      } catch (e) {
          console.log(e);
          //document.getElementById("addliquidtext").innerHTML = 'Approval failed';
          modalDialog('Connect', "Approval failed", "danger");
          Swal.fire({
              icon: 'error',
              text: 'Approval failed',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(/^0x0+$/.test(mypair) == false) {
          await liquiditypool.methods.poolhighkey(mypair).call().then(function (swapresult) {
              myhighkey = parseInt(DOMPurify.sanitize(swapresult));
          });
          section = Math.floor(networkvars[0] / networkvars[2]);
          if(myhighkey != section) {
              Swal.fire({
                  icon: 'info',
                  title: 'Syncing AMM',
                  text: 'Authorizing Metamask to sync AMM pair...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Syncing AMM...</div><br>' + prevtext;
              try {
                  await liquiditypool.methods.syncAMM(mypair).send({"from":chosenaccount,"gasLimit": 2500000,"gasPrice": gasPrice});
              } catch (e) {
                  console.log(e);
                  //document.getElementById("SwapSummary").innerHTML = 'Syncing failed';
                  document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >Error: Syncing failed!</div>';
                  Swal.fire({
                      icon: 'error',
                      title: 'Syncing failed',
                      confirmButtonText: 'Close'
                  });
                  hideSpinner();
                  return;
              }
              document.getElementById("SwapAmount").value = '';
              document.getElementById("SwapAmount2").value = '';
              lastchecked = 0;
              lastchecked2 = 0;
          }
      } else {
          document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >Pair does not exist yet. Please deposit liquidity to the pair.</div>';
          Swal.fire({
              icon: 'warning',
              title: 'AMM pair',
              text: 'Pair does not exist yet. Please deposit liquidity to the pair.',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(myhighkey != section) {        
          document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >This pair is now in sync. Please recalculate your swap.</div>';
          Swal.fire({
              icon: 'info',
              text: 'This pair is now in sync. Please recalculate your swap.',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(parseFloat(swapval) == 0) {
          document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Amount can not be zero</div>';
          Swal.fire({
              icon: 'warning',
              text: 'Amount can not be zero',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(perc == 0 || perc > 1000) {        
          document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Percentage incorrect, usually 1-10% is recommended</div>';
          Swal.fire({
              icon: 'warning',
              text: 'Percentage incorrect, usually 1-10% is recommended',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      org1 = new BN(org1).times(new BN('100000000'));
      org2 = new BN(org2).times(new BN(decimals.toString()));
      if(bayselect == 0 || bayselect == 1) {
          if(weth) {
              await window.web3.eth.getBalance(myaccounts, function(myliquid2) {
                  if (org2.gt(new BN(DOMPurify.sanitize(myliquid2)))) {
                      console.log(org2.toFixed())
                      console.log(myliquid2.toFixed())
                      Swal.fire({
                          icon: 'warning',
                          text: 'Not enough coins for deposit',
                          confirmButtonText: 'Close'
                      });
                      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Not enough coins for deposit</div>';
                      returnthis = 1;
                  }
              });
          } else {
              await coin1contract.methods.balanceOf(chosenaccount).call().then(function (myliquid2) {
                  if (org2.gt(new BN(DOMPurify.sanitize(myliquid2)))) {
                      Swal.fire({
                          icon: 'warning',
                          text: 'Not enough coins for deposit',
                          confirmButtonText: 'Close'
                      });
                      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Not enough coins for deposit</div>';
                      returnthis = 1;
                  }
              });
          }
      } else {
          if(bayselect == 2) {
              await baylcontract.methods.balanceOf(chosenaccount).call().then(function (myliquid2) {
                  if (org1.gt(new BN(DOMPurify.sanitize(myliquid2)))) {
                      Swal.fire({
                          icon: 'warning',
                          text: 'Not enough liquid BAYL coins for deposit',
                          confirmButtonText: 'Close'
                      });
                      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Not enough liquid funds for deposit</div>';
                      returnthis = 1;
                  }
              });
          } else {
              await bayrcontract.methods.balanceOf(chosenaccount).call().then(function (myrval2) {
                  if (org1.gt(new BN(DOMPurify.sanitize(myrval2)))) {
                      Swal.fire({
                          icon: 'warning',
                          text: 'Not enough reserve BAYR coins for deposit',
                          confirmButtonText: 'Close'
                      });
                      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Not enough reserve funds for deposit</div>';
                      returnthis = 1;
                  }
              });
          }
      }
      if(returnthis == 1) {
          hideSpinner();
          return;
      }
      var block = JSON.parse(DOMPurify.sanitize(JSON.stringify(await web3.eth.getBlock(await web3.eth.getBlockNumber()))));;
      var deadline = (block.timestamp + 1200).toString();
      if(lastSelect == "SwapAmount2") {
          swapval = new BN(swapval.toString()).times(new BN(decimals.toString()));
      } else {
          swapval = new BN(swapval.toString()).times(new BN('100000000'));
      }
      swapval = swapval.toString();
      lastMinMax2 = lastMinMax.toString();
      console.log(swapval);
      console.log(lastMinMax2);
      console.log(chosenaccount);
      console.log(deadline);
      console.log(coin1);
      console.log(bayaddy);
      Swal.fire({
          icon: 'info',
          title: 'Swap',
          text: 'Attempting to perform the swap, please approve the transaction...',
          confirmButtonText: 'Close'
      });
      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-warning" >Attempting to perform the swap, please approve the transaction...</div><br>' + prevtext;
      try {
          if(bayselect == 0) {
              //Buying BitBay coins
              if(lastSelect == "SwapAmount") { //Maximum coins paid
                  if(weth) {
                      await routercontract.methods.swapETHForExactTokens(swapval,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"value":lastMinMax2,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapTokensForExactTokens(swapval,lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              } else { //Minimum BAY received
                  if(weth) {
                      await routercontract.methods.swapExactETHForTokens(lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"value":swapval,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapExactTokensForTokens(swapval,lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              }
          }
          if(bayselect == 1) {
              //Buying BitBay Reserve coins
              if(lastSelect == "SwapAmount") { //Maximum coins paid
                  if(weth) {
                      await routercontract.methods.swapETHForExactTokens(swapval,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"value":lastMinMax2,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapTokensForExactTokens(swapval,lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              } else { //Minimum BAY received
                  if(weth) {
                      await routercontract.methods.swapExactETHForTokens(lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"value":swapval,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapExactTokensForTokens(swapval,lastMinMax2,[coin1,bayaddy],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              }
          }
          if(bayselect == 2) {
              //Selling BitBay coins
              if(lastSelect == "SwapAmount") { //Minimum coins received
                  if(weth) {
                      await routercontract.methods.swapExactTokensForETH(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapExactTokensForTokens(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              } else { //Maximum BAY paid
                  if(weth) {
                      await routercontract.methods.swapTokensForExactETH(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapTokensForExactTokens(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              }
          }
          if(bayselect == 3) {
              //Selling BitBay Reserve coins
              if(lastSelect == "SwapAmount") { //Minimum coins received
                  if(weth) {
                      await routercontract.methods.swapExactTokensForETH(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapExactTokensForTokens(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              } else { //Maximum BAY paid
                  if(weth) {
                      await routercontract.methods.swapTokensForExactETH(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  } else {
                      await routercontract.methods.swapTokensForExactTokens(swapval,lastMinMax2,[bayaddy,coin1],chosenaccount,deadline,exchange).send({"from":chosenaccount,"gasLimit": 5000000,"gasPrice": gasPrice});
                  }
              }
          }
      } catch (e) {
          console.log(e);
          document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-danger" >Error: Swap failed!</div>';
          Swal.fire({
              icon: 'error',
              title: 'Swap failed',
              text: e.message,
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      document.getElementById("SwapSummary").innerHTML = '<div class="callout callout-success" >Success!</div><br>' + prevtext;
      document.getElementById("SwapAmount").value = '';
      document.getElementById("SwapAmount2").value = '';
      checkbalances();
      Swal.fire({
          icon: 'success',
          title: 'Swap Successful!',
          confirmButtonText: 'Close'
      });
      hideSpinner();
    } catch (e) {
      console.log(e);
      hideSpinner();
    }
}

async function withdrawLP() {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    var wval = document.getElementById("WithdrawAmount").value;
    var waccount = myaccounts;
    var prevtext = document.getElementById("LPdetails1").innerHTML;
    var coin1 = document.getElementById("Coin1").value;
    var weth = false;
    if(coin1 == 0) {
        weth = true;
    }
    coin1 = Object.values(pairs[coin1])[0];
    var exchange = document.getElementById("exchangeSelect").value;
    exchange = Object.values(exchanges[exchange])[0];
    var myrouter = Object.values(routers[0])[0];
    var routercontract = new web3.eth.Contract(RouterABI, myrouter);
    var exchangecontract = new web3.eth.Contract(FactoryABI, exchange);
    var bayselect = document.getElementById("Coin2").value;
    var bayaddy = '';
    var mypair = '';
    var myhighkey = 0;
    var section = 0;
    var returnthis = 0;
    var allowance = 0;
    if(bayselect == 0) {
        bayaddy = BAYLaddy;
    }
    if(bayselect == 1) {
        bayaddy = BAYRaddy;
    }
    await exchangecontract.methods.getPair(bayaddy, coin1).call().then(function (wresult) {
        mypair = DOMPurify.sanitize(wresult);
    });
    var paircontract = new web3.eth.Contract(PairABI, mypair);
    try {
      try {
          showSpinner();
          await paircontract.methods.allowance(waccount, myrouter).call().then(function (wresult) {
              allowance = DOMPurify.sanitize(wresult);
          });
          if(parseInt(allowance) == 0) {
              Swal.fire({
                  icon: 'info',
                  title: 'Allowance',
                  text: 'Authorizing Metamask allowance for LP Tokens...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("LPdetails1").innerHTML = 'Waiting for router allowance authorization on the blockchain for the LP Tokens...<br><br>' + prevtext;
              await paircontract.methods.approve(myrouter, "9999999999999999999999999999999999999999999999999999999999999999999999").send({"from":waccount,"gasLimit": 2500000,"gasPrice": gasPrice});
          }
      } catch (e) {
          console.log(e);
          document.getElementById("LPdetails1").innerHTML = 'Approval failed';
          Swal.fire({
              icon: 'error',
              title: 'Approval failed',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(/^0x0+$/.test(mypair) == false) {
          await liquiditypool.methods.poolhighkey(mypair).call().then(function (wresult) {
              myhighkey = parseInt(DOMPurify.sanitize(wresult));
          });
          section = Math.floor(networkvars[0] / networkvars[2]);
          if(myhighkey != section) {
              Swal.fire({
                  icon: 'info',
                  title: 'Syncing AMM',
                  text: 'Authorizing Metamask to sync AMM pair...',
                  confirmButtonText: 'Close'
              });
              document.getElementById("LPdetails1").innerHTML = 'Syncing AMM...<br><br>' + prevtext;
              try {
                  await liquiditypool.methods.syncAMM(mypair).send({"from":waccount,"gasLimit": 2500000,"gasPrice": gasPrice});
              } catch (e) {
                  console.log(e);
                  document.getElementById("LPdetails1").innerHTML = 'Syncing failed';
                  Swal.fire({
                      icon: 'error',
                      title: 'Syncing failed',
                      confirmButtonText: 'Close'
                  });
                  hideSpinner();
                  return;
              }
              document.getElementById("LPdetails1").value = '';
              lastchecked = 0;
              lastchecked2 = 0;
          }
      } else {
          document.getElementById("LPdetails1").innerHTML = 'Pair does not exist yet. Please deposit liquidity to the pair.';
          Swal.fire({
              icon: 'info',
              text: 'Pair does not exist yet. Please deposit liquidity to the pair.',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(myhighkey != section) {
          document.getElementById("LPdetails1").innerHTML = 'This pair is now in sync. Please recalculate your withdrawal.';
          Swal.fire({
              icon: 'info',
              text: 'This pair is now in sync. Please recalculate your withdrawal.',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      if(parseFloat(wval) == 0) {
          document.getElementById("LPdetails1").innerHTML = 'Amount can not be zero';
          Swal.fire({
              icon: 'warning',
              text: 'Amount can not be zero',
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      await paircontract.methods.balanceOf(waccount).call().then(function (wval2) {
          wval2 = new BN(DOMPurify.sanitize(wval2))
          if(new BN(wval).gt(wval2)) {
              Swal.fire({
                  icon: 'warning',
                  text: 'Not enough LP tokens for withdrawal',
                  confirmButtonText: 'Close'
              });
              document.getElementById("LPdetails1").innerHTML = 'Not enough LP tokens for withdrawal';
              returnthis = 1;
          }
      })
      if(returnthis == 1) {
          hideSpinner();
          return;
      }
      var block = JSON.parse(DOMPurify.sanitize(JSON.stringify(await web3.eth.getBlock(await web3.eth.getBlockNumber()))));;
      var deadline = (block.timestamp + 1200).toString();
      console.log(wval);
      Swal.fire({
          icon: 'info',
          title: 'Withdrawal',
          text: 'Attempting to perform the withdrawal, please approve the transaction...',          
          confirmButtonText: 'Close'
      });
      document.getElementById("LPdetails1").innerHTML = 'Attempting to perform the withdrawal, please approve the transaction...<br><br>' + prevtext;
      try {
          if(weth) {
              await routercontract.methods.removeLiquidityETH(bayaddy,wval,withdrawMin1,withdrawMin2,waccount,deadline,exchange).send({"from":waccount,"gasLimit": 9000000,"gasPrice": gasPrice});
          } else {
              await routercontract.methods.removeLiquidity(coin1,bayaddy,wval,withdrawMin1,withdrawMin2,waccount,deadline,exchange).send({"from":waccount,"gasLimit": 9000000,"gasPrice": gasPrice});
          }
      } catch (e) {
          console.log(e);
          document.getElementById("LPdetails1").innerHTML = 'Withdrawal failed';
          Swal.fire({
              icon: 'error',
              title: 'Withdrawal failed',
              text: e.message,
              confirmButtonText: 'Close'
          });
          hideSpinner();
          return;
      }
      document.getElementById("LPdetails1").innerHTML = 'Success!<br><br>' + prevtext;
      checkbalances();
      Swal.fire({
          icon: 'success',
          title: 'Withdrawal Successful!',
          confirmButtonText: 'Close'
      });
      hideSpinner();
    } catch (e) {
      console.log(e);
      hideSpinner();
    }
}

//Useful for situations where pair becomes illiquid and ratio of funds has to be fixed manually
async function depositToWETH(wethval, wethcont) {
    if(lastrun > (Math.floor(Date.now() / 1000))) {
        return;
    }
    lastrun = (Math.floor(Date.now() / 1000)) + 7;
    var wethcontract = new web3.eth.Contract(WETHabi, wethcont);
    console.log("Adding funds to WETH contract...");
    await wethcontract.methods.deposit().send({"from":myaccounts,"value":wethval,"gasLimit": 1000000,"gasPrice": gasPrice});
    console.log("Success!");
}

setInterval(checkbalances, 90000);

function modalDialog(title, msg, content_type="") {
  if (content_type == "info") 
    msg = '<div class="callout callout-info">'+msg+'</div>';
  if (content_type == "success") 
    msg = '<div class="callout callout-success">'+msg+'</div>';
  if (content_type == "danger") 
    msg = '<div class="callout callout-danger">'+msg+'</div>';
  if (content_type == "warning")  
    msg = '<div class="callout callout-warning">'+msg+'</div>';
  if (content_type == "no-border")  
    msg = '<div class="callout callout-no-border">'+msg+'</div>';
  // Create the Dynamic modal
  new Modal({
    title: title,
    content: msg
  }).show();  
}

</script>
</body>
</html>